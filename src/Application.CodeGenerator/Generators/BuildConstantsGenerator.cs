using System;
using System.Globalization;
using System.IO;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace Application.CodeGenerator.Generators;

sealed class BuildConstantsGenerator : ICodeGenerationTask
{
    internal const string TaskId = "BuildConstants";

    public string Id => TaskId;

    public string GetDefaultOutputPath(string applicationBaseDirectory) =>
        Path.Combine(applicationBaseDirectory, "GeneratedBuildConstants.cs");

    public async Task GenerateAsync(CodeGenerationContext context, CancellationToken cancellationToken)
    {
        ArgumentNullException.ThrowIfNull(context);

        cancellationToken.ThrowIfCancellationRequested();

        var options = context.Options;
        var outputPath = context.GetOutputPath(Id);
        var directory = Path.GetDirectoryName(outputPath);

        if (!string.IsNullOrWhiteSpace(directory))
        {
            Directory.CreateDirectory(directory);
        }

        var builder = new StringBuilder();

        builder.AppendLine("// <auto-generated />");
        builder.AppendLine("// Generated by Application.CodeGenerator. Do not edit manually.");
        builder.AppendLine($"// Generated on {context.UtcNow:O} UTC");
        builder.AppendLine();
        builder.AppendLine("#nullable enable");
        builder.AppendLine();
        builder.AppendLine("namespace Build");
        builder.AppendLine("{");
        builder.AppendLine("    /// <summary>");
        builder.AppendLine("    /// Contains application build constants.");
        builder.AppendLine("    /// </summary>");
        builder.AppendLine("    internal static class Constants");
        builder.AppendLine("    {");
        AppendConstant(builder, "AppName", options.AppName, "The application name.");
        builder.AppendLine();
        AppendConstant(builder, "AppTitle", options.AppTitle, "The application title.");
        builder.AppendLine();
        AppendConstant(builder, "AppDescription", options.AppDescription, "The application description.");
        builder.AppendLine();
        AppendConstant(builder, "Version", options.Version, "The application version.");
        builder.AppendLine();
        AppendConstant(builder, "AppTag", options.AppTag, "The application AppTag.");
        builder.AppendLine();
        AppendConstant(builder, "BuildPayload", options.BuildPayload, "The application build payload.");
        builder.AppendLine("    }");
        builder.AppendLine();
        builder.AppendLine("    /// <inheritdoc/>");
        builder.AppendLine("    internal class ApplicationConstants : global::Application.Abstractions.Application.IApplicationConstants");
        builder.AppendLine("    {");
        builder.AppendLine("        /// <inheritdoc/>");
        builder.AppendLine("        public static global::Application.Abstractions.Application.IApplicationConstants Instance { get; } = new global::Build.ApplicationConstants();");
        builder.AppendLine();
        AppendStaticAccessor(builder, "AppName", "The application name.");
        builder.AppendLine();
        AppendStaticAccessor(builder, "AppTitle", "The application title.");
        builder.AppendLine();
        AppendStaticAccessor(builder, "AppDescription", "The application description.");
        builder.AppendLine();
        AppendStaticAccessor(builder, "Version", "The application version.");
        builder.AppendLine();
        AppendStaticAccessor(builder, "AppTag", "The application AppTag.");
        builder.AppendLine();
        AppendStaticAccessor(builder, "BuildPayload", "The application build payload.");
        builder.AppendLine();
        builder.AppendLine("        string global::Application.Abstractions.Application.IApplicationConstants.AppName => AppName;");
        builder.AppendLine();
        builder.AppendLine("        string global::Application.Abstractions.Application.IApplicationConstants.AppTitle => AppTitle;");
        builder.AppendLine();
        builder.AppendLine("        string global::Application.Abstractions.Application.IApplicationConstants.AppDescription => AppDescription;");
        builder.AppendLine();
        builder.AppendLine("        string global::Application.Abstractions.Application.IApplicationConstants.Version => Version;");
        builder.AppendLine();
        builder.AppendLine("        string global::Application.Abstractions.Application.IApplicationConstants.AppTag => AppTag;");
        builder.AppendLine();
        builder.AppendLine("        string global::Application.Abstractions.Application.IApplicationConstants.BuildPayload => BuildPayload;");
        builder.AppendLine("    }");
        builder.AppendLine();
        builder.AppendLine("    /// <summary>");
        builder.AppendLine("    /// Base command class with application constants support.");
        builder.AppendLine("    /// </summary>");
        builder.AppendLine("    /// <typeparam name=\"THostApplicationBuilder\">The type of host application builder.</typeparam>");
        builder.AppendLine("    public abstract class BaseCommand<[global::System.Diagnostics.CodeAnalysis.DynamicallyAccessedMembers(global::System.Diagnostics.CodeAnalysis.DynamicallyAccessedMemberTypes.All)] THostApplicationBuilder> : global::Application.Abstractions.Application.BaseCommand<THostApplicationBuilder>");
        builder.AppendLine("        where THostApplicationBuilder : global::Microsoft.Extensions.Hosting.IHostApplicationBuilder");
        builder.AppendLine("    {");
        builder.AppendLine("        /// <inheritdoc/>");
        builder.AppendLine("        public override global::Application.Abstractions.Application.IApplicationConstants ApplicationConstants { get; } = global::Build.ApplicationConstants.Instance;");
        builder.AppendLine("    }");
        builder.AppendLine("}");

        var contents = builder.ToString();

        if (File.Exists(outputPath))
        {
            var existing = await File.ReadAllTextAsync(outputPath, cancellationToken);
            if (string.Equals(existing, contents, StringComparison.Ordinal))
            {
                return;
            }
        }

        var encoding = new UTF8Encoding(encoderShouldEmitUTF8Identifier: false);
        await File.WriteAllTextAsync(outputPath, contents, encoding, cancellationToken);
    }

    private static void AppendStaticAccessor(StringBuilder builder, string name, string documentation)
    {
        builder.AppendLine("        /// <summary>");
        builder.Append("        /// ");
        builder.AppendLine(documentation);
        builder.AppendLine("        /// </summary>");
        builder.Append("        public static string ");
        builder.Append(name);
        builder.AppendLine(" => global::Build.Constants." + name + ";");
    }

    private static void AppendConstant(StringBuilder builder, string name, string value, string documentation)
    {
        builder.AppendLine("        /// <summary>");
        builder.Append("        /// ");
        builder.AppendLine(documentation);
        builder.AppendLine("        /// </summary>");
        builder.Append("        public const string ");
        builder.Append(name);
        builder.Append(" = ");
        builder.Append(ToLiteral(value));
        builder.AppendLine(";");
    }

    private static string ToLiteral(string value)
    {
        var builder = new StringBuilder(value.Length + 2);
        builder.Append('"');

        foreach (var character in value)
        {
            builder.Append(character switch
            {
                '"' => "\\\"",
                '\\' => "\\\\",
                '\0' => "\\0",
                '\a' => "\\a",
                '\b' => "\\b",
                '\f' => "\\f",
                '\n' => "\\n",
                '\r' => "\\r",
                '\t' => "\\t",
                '\v' => "\\v",
                _ when char.IsControl(character) => FormatControlCharacter(character),
                _ => character.ToString(CultureInfo.InvariantCulture),
            });
        }

        builder.Append('"');
        return builder.ToString();
    }

    private static string FormatControlCharacter(char character)
    {
        return string.Format(CultureInfo.InvariantCulture, "\\u{0:x4}", (int)character);
    }
}
