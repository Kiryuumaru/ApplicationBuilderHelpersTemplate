using Application.Common.Extensions;
using Nuke.Common;
using Nuke.Common.IO;
using Serilog;
using System;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Text.Json.Nodes;

partial class Build
{
    // ─────────────────────────────────────────────────────────────
    // Environment Configuration Record
    // ─────────────────────────────────────────────────────────────

    record EnvironmentConfig(string Tag, string Name, string ShortName);

    // ─────────────────────────────────────────────────────────────
    // Base Build Overrides
    // ─────────────────────────────────────────────────────────────

    public override string[] EnvironmentBranches =>
        [.. Environments.Select(e => e.Tag)];

    public override string MainEnvironmentBranch =>
        Environments.Last().Tag;

    // ─────────────────────────────────────────────────────────────
    // Targets
    // ─────────────────────────────────────────────────────────────

    Target Clean => _ => _
        .Executes(() =>
        {
            foreach (var path in RootDirectory.GetFiles("**", 99).Where(i => i.Name.EndsWith(".csproj")))
            {
                if (path.Name == "_build.csproj")
                {
                    continue;
                }
                Log.Information("Cleaning {path}", path);
                (path.Parent / "bin").DeleteDirectory();
                (path.Parent / "obj").DeleteDirectory();
            }
            (RootDirectory / ".vs").DeleteDirectory();
            (RootDirectory / "src" / "Presentation.WebApp" / "app.db").DeleteDirectory();
        });

    Target Init => _ => _
        .Executes(() =>
        {
            GenerateCredsJson();
            GenerateAppEnvironmentsCs();
        });

    // ─────────────────────────────────────────────────────────────
    // creds.json Generation
    // ─────────────────────────────────────────────────────────────

    void GenerateCredsJson()
    {
        var credsPath = RootDirectory / "creds.json";

        if (File.Exists(credsPath))
        {
            Log.Information("creds.json already exists at {path}", credsPath);
            return;
        }

        Log.Information("Generating creds.json at {path}", credsPath);

        var credsObject = new JsonObject();

        foreach (var env in Environments)
        {
            credsObject[env.Tag] = new JsonObject
            {
                ["jwt"] = new JsonObject
                {
                    ["secret"] = RandomHelpers.Alphanumeric(64),
                    ["issuer"] = "ApplicationBuilderHelpers",
                    ["audience"] = "ApplicationBuilderHelpers"
                }
            };
        }

        var options = new JsonSerializerOptions
        {
            WriteIndented = true
        };

        File.WriteAllText(credsPath, credsObject.ToJsonString(options));

        Log.Information("creds.json generated successfully with branches: {branches}", string.Join(", ", Environments.Select(e => e.Tag)));
    }

    // ─────────────────────────────────────────────────────────────
    // AppEnvironments.Generated.cs Generation
    // ─────────────────────────────────────────────────────────────

    void GenerateAppEnvironmentsCs()
    {
        var path = RootDirectory / "src" / "Domain" / "AppEnvironment" / "Constants" / "AppEnvironments.Generated.cs";

        Log.Information("Generating AppEnvironments.Generated.cs at {path}", path);

        var sb = new StringBuilder();

        // Header
        sb.AppendLine("// <auto-generated />");
        sb.AppendLine("namespace Domain.AppEnvironment.Constants;");
        sb.AppendLine();
        sb.AppendLine("public static partial class AppEnvironments");
        sb.AppendLine("{");

        // Static properties for each environment
        foreach (var env in Environments)
        {
            sb.AppendLine($"    public static Models.AppEnvironment {env.Name} {{ get; }} = new()");
            sb.AppendLine("    {");
            sb.AppendLine($"        Environment = \"{env.Name}\",");
            sb.AppendLine($"        EnvironmentShort = \"{env.ShortName}\",");
            sb.AppendLine($"        Tag = \"{env.Tag}\"");
            sb.AppendLine("    };");
            sb.AppendLine();
        }

        // AllValues partial property implementation
        sb.AppendLine($"    public static partial Models.AppEnvironment[] AllValues => [{string.Join(", ", Environments.Select(e => e.Name))}];");
        sb.AppendLine("}");

        File.WriteAllText(path, sb.ToString());
        Log.Information("AppEnvironments.Generated.cs generated successfully");
    }
}
