@inject IAuthStateProvider AuthStateProvider
@inject IAuthenticationClient AuthClient
@inject NavigationManager Navigation

<nav class="fixed top-0 z-50 w-full bg-white border-b border-secondary-200 dark:bg-secondary-800 dark:border-secondary-700">
    <div class="px-3 py-3 lg:px-5 lg:pl-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center justify-start rtl:justify-end">
                <button @onclick="ToggleSidebar" type="button" class="inline-flex items-center p-2 text-sm text-secondary-500 rounded-lg sm:hidden hover:bg-secondary-100 focus:outline-none focus:ring-2 focus:ring-secondary-200 dark:text-secondary-400 dark:hover:bg-secondary-700 dark:focus:ring-secondary-600">
                    <span class="sr-only">Open sidebar</span>
                    <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path clip-rule="evenodd" fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z"></path>
                    </svg>
                </button>
                <a href="/" class="flex ms-2 md:me-24">
                    <svg class="w-8 h-8 text-primary-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M9.504 1.132a1 1 0 01.992 0l1.75 1a1 1 0 11-.992 1.736L10 3.152l-1.254.716a1 1 0 11-.992-1.736l1.75-1zM5.618 4.504a1 1 0 01-.372 1.364L5.016 6l.23.132a1 1 0 11-.992 1.736L4 7.723V8a1 1 0 01-2 0V6a.996.996 0 01.52-.878l1.734-.99a1 1 0 011.364.372zm8.764 0a1 1 0 011.364-.372l1.733.99A1.002 1.002 0 0118 6v2a1 1 0 11-2 0v-.277l-.254.145a1 1 0 11-.992-1.736l.23-.132-.23-.132a1 1 0 01-.372-1.364zm-7 4a1 1 0 011.364-.372L10 8.848l1.254-.716a1 1 0 11.992 1.736L11 10.58V12a1 1 0 11-2 0v-1.42l-1.246-.712a1 1 0 01-.372-1.364zM3 11a1 1 0 011 1v1.42l1.246.712a1 1 0 11-.992 1.736l-1.75-1A1 1 0 012 14v-2a1 1 0 011-1zm14 0a1 1 0 011 1v2a1 1 0 01-.504.868l-1.75 1a1 1 0 11-.992-1.736L16 13.42V12a1 1 0 011-1zm-9.618 5.504a1 1 0 011.364-.372l.254.145V16a1 1 0 112 0v.277l.254-.145a1 1 0 11.992 1.736l-1.735.992a.995.995 0 01-1.022 0l-1.735-.992a1 1 0 01-.372-1.364z" clip-rule="evenodd"/>
                    </svg>
                    <span class="self-center text-xl font-semibold sm:text-2xl whitespace-nowrap dark:text-white ms-3">Application</span>
                </a>
            </div>
            <div class="flex items-center">
                <div class="flex items-center ms-3">
                    @if (_isAuthenticated)
                    {
                        <div class="relative">
                            <button @onclick="ToggleUserMenu" type="button" class="flex text-sm bg-secondary-800 rounded-full focus:ring-4 focus:ring-secondary-300 dark:focus:ring-secondary-600" aria-expanded="false">
                                <span class="sr-only">Open user menu</span>
                                <div class="w-8 h-8 rounded-full bg-primary-600 flex items-center justify-center text-white font-semibold">
                                    @GetUserInitial()
                                </div>
                            </button>
                            @if (_showUserMenu)
                            {
                                <div class="absolute right-0 z-50 mt-2 text-base list-none bg-white divide-y divide-secondary-100 rounded shadow dark:bg-secondary-700 dark:divide-secondary-600">
                                    <div class="px-4 py-3">
                                        <p class="text-sm text-secondary-900 dark:text-white">@_username</p>
                                        <p class="text-sm font-medium text-secondary-900 truncate dark:text-secondary-300">@_email</p>
                                    </div>
                                    <ul class="py-1">
                                        <li>
                                            <a href="account/profile" class="block px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-100 dark:text-secondary-300 dark:hover:bg-secondary-600 dark:hover:text-white">Profile</a>
                                        </li>
                                        <li>
                                            <a href="account/settings" class="block px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-100 dark:text-secondary-300 dark:hover:bg-secondary-600 dark:hover:text-white">Settings</a>
                                        </li>
                                        <li>
                                            <button @onclick="Logout" class="block w-full text-left px-4 py-2 text-sm text-secondary-700 hover:bg-secondary-100 dark:text-secondary-300 dark:hover:bg-secondary-600 dark:hover:text-white">Sign out</button>
                                        </li>
                                    </ul>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <a href="auth/login" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-500 focus:outline-none dark:focus:ring-primary-800">
                            Sign In
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</nav>

@code {
    [Parameter]
    public EventCallback OnToggleSidebar { get; set; }

    private bool _isAuthenticated;
    private bool _showUserMenu;
    private string? _username;
    private string? _email;

    protected override void OnInitialized()
    {
        UpdateAuthState();
        AuthStateProvider.OnStateChanged += HandleAuthStateChanged;
    }

    private void UpdateAuthState()
    {
        var state = AuthStateProvider.CurrentState;
        _isAuthenticated = state.IsAuthenticated;
        _username = state.Username;
        _email = state.Email;
    }

    private void HandleAuthStateChanged()
    {
        UpdateAuthState();
        InvokeAsync(StateHasChanged);
    }

    private string GetUserInitial()
    {
        if (!string.IsNullOrEmpty(_username))
            return _username[0].ToString().ToUpper();
        if (!string.IsNullOrEmpty(_email))
            return _email[0].ToString().ToUpper();
        return "U";
    }

    private void ToggleSidebar()
    {
        OnToggleSidebar.InvokeAsync();
    }

    private void ToggleUserMenu()
    {
        _showUserMenu = !_showUserMenu;
    }

    private async Task Logout()
    {
        await AuthClient.LogoutAsync();
        await AuthStateProvider.ClearStateAsync();
        _showUserMenu = false;
        Navigation.NavigateTo("/", forceLoad: true);
    }

    public void Dispose()
    {
        AuthStateProvider.OnStateChanged -= HandleAuthStateChanged;
    }
}
