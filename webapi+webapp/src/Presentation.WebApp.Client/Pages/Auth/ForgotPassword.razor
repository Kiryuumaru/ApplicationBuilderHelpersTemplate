@page "/auth/forgot-password"
@layout AuthLayout
@inject IAuthenticationClient AuthClient

<PageTitle>Forgot Password</PageTitle>

<Card>
    <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white mb-2">
        Forgot your password?
    </h1>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
        Enter your email address and we'll send you a link to reset your password.
    </p>
    
    @if (_submitted)
    {
        <Alert Type="Alert.AlertType.Success" Title="Email sent!" Message="If an account exists with that email, you will receive a password reset link shortly." />
        
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">
            <a href="auth/login" class="font-medium text-primary-600 hover:underline dark:text-primary-500">
                ‚Üê Back to sign in
            </a>
        </p>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" />
        }
        
        <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="forgot-password">
            <DataAnnotationsValidator />
            
            <TextInput Id="email" 
                       Type="email" 
                       Label="Your email" 
                       Placeholder="name@company.com" 
                       @bind-Value="_model.Email"
                       Required="true"
                       ErrorMessage="@GetValidationError(nameof(_model.Email))" />
            
            <Button Type="submit" Loading="_isLoading" LoadingText="Sending..." class="w-full">
                Reset password
            </Button>
            
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">
                Remember your password? <a href="auth/login" class="font-medium text-primary-600 hover:underline dark:text-primary-500">Sign in</a>
            </p>
        </EditForm>
    }
</Card>

@code {
    private ForgotPasswordModel _model = new();
    private bool _isLoading;
    private bool _submitted;
    private string? _errorMessage;
    private EditContext? _editContext;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private async Task HandleSubmit()
    {
        _errorMessage = null;
        _isLoading = true;

        try
        {
            await AuthClient.ForgotPasswordAsync(_model.Email!);
            _submitted = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetValidationError(string fieldName)
    {
        return _editContext?.GetValidationMessages(new FieldIdentifier(_model, fieldName)).FirstOrDefault();
    }

    private class ForgotPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Invalid email address")]
        public string? Email { get; set; }
    }
}
