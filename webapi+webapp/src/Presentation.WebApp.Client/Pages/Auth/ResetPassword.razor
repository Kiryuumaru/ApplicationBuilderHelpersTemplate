@page "/auth/reset-password"
@layout AuthLayout
@inject IAuthenticationClient AuthClient
@inject NavigationManager Navigation

<PageTitle>Reset Password</PageTitle>

<Card>
    <h1 class="text-xl font-bold leading-tight tracking-tight text-secondary-900 md:text-2xl dark:text-white mb-6">
        Reset your password
    </h1>
    
    @if (_success)
    {
        <Alert Type="Alert.AlertType.Success" Title="Password reset!" Message="Your password has been successfully reset." />
        
        <div class="mt-4">
            <Button OnClick="@(() => Navigation.NavigateTo("auth/login"))" class="w-full">
                Sign in with new password
            </Button>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" />
        }
        
        <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="reset-password">
            <DataAnnotationsValidator />
            
            <TextInput Id="password" 
                       Type="password" 
                       Label="New password" 
                       Placeholder="••••••••" 
                       @bind-Value="_model.Password"
                       Required="true"
                       HelperText="At least 8 characters"
                       ErrorMessage="@GetValidationError(nameof(_model.Password))" />
            
            <TextInput Id="confirmPassword" 
                       Type="password" 
                       Label="Confirm new password" 
                       Placeholder="••••••••" 
                       @bind-Value="_model.ConfirmPassword"
                       Required="true"
                       ErrorMessage="@GetValidationError(nameof(_model.ConfirmPassword))" />
            
            <Button Type="submit" Loading="_isLoading" LoadingText="Resetting..." class="w-full">
                Reset password
            </Button>
        </EditForm>
    }
</Card>

@code {
    private ResetPasswordModel _model = new();
    private bool _isLoading;
    private bool _success;
    private string? _errorMessage;
    private EditContext? _editContext;

    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);

        if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            _errorMessage = "Invalid password reset link.";
        }
    }

    private async Task HandleSubmit()
    {
        _errorMessage = null;

        if (_model.Password != _model.ConfirmPassword)
        {
            _errorMessage = "Passwords do not match";
            return;
        }

        _isLoading = true;

        try
        {
            var result = await AuthClient.ResetPasswordAsync(Email!, Token!, _model.Password!);

            if (result)
            {
                _success = true;
            }
            else
            {
                _errorMessage = "Failed to reset password. The link may have expired.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetValidationError(string fieldName)
    {
        return _editContext?.GetValidationMessages(new FieldIdentifier(_model, fieldName)).FirstOrDefault();
    }

    private class ResetPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required")]
        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters")]
        public string? Password { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your password")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string? ConfirmPassword { get; set; }
    }
}
