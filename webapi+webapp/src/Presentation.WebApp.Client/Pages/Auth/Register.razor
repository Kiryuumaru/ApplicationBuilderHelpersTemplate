@page "/auth/register"
@layout AuthLayout
@inject IAuthenticationClient AuthClient
@inject IAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Create Account</PageTitle>

<Card>
    <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white mb-6">
        Create an account
    </h1>
    
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" />
    }
    
    <EditForm Model="_model" OnValidSubmit="HandleRegister" FormName="register">
        <DataAnnotationsValidator />
        
        <TextInput Id="username" 
                   Type="text" 
                   Label="Username" 
                   Placeholder="johndoe" 
                   @bind-Value="_model.Username"
                   Required="true"
                   ErrorMessage="@GetValidationError(nameof(_model.Username))" />
        
        <TextInput Id="email" 
                   Type="email" 
                   Label="Your email" 
                   Placeholder="name@company.com" 
                   @bind-Value="_model.Email"
                   Required="true"
                   ErrorMessage="@GetValidationError(nameof(_model.Email))" />
        
        <TextInput Id="password" 
                   Type="password" 
                   Label="Password" 
                   Placeholder="••••••••" 
                   @bind-Value="_model.Password"
                   Required="true"
                   HelperText="At least 8 characters"
                   ErrorMessage="@GetValidationError(nameof(_model.Password))" />
        
        <TextInput Id="confirmPassword" 
                   Type="password" 
                   Label="Confirm password" 
                   Placeholder="••••••••" 
                   @bind-Value="_model.ConfirmPassword"
                   Required="true"
                   ErrorMessage="@GetValidationError(nameof(_model.ConfirmPassword))" />
        
        <div class="flex items-start mb-4">
            <div class="flex items-center h-5">
                <input id="terms" type="checkbox" @bind="_model.AcceptTerms" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-primary-300 dark:bg-gray-700 dark:border-gray-600 dark:focus:ring-primary-600 dark:ring-offset-gray-800" required />
            </div>
            <div class="ml-3 text-sm">
                <label for="terms" class="font-light text-gray-500 dark:text-gray-300">
                    I accept the <a class="font-medium text-primary-600 hover:underline dark:text-primary-500" href="#">Terms and Conditions</a>
                </label>
            </div>
        </div>
        
        <Button Type="submit" Loading="_isLoading" LoadingText="Creating account..." class="w-full">
            Create an account
        </Button>
        
        <p class="text-sm font-light text-gray-500 dark:text-gray-400 mt-4">
            Already have an account? <a href="auth/login" class="font-medium text-primary-600 hover:underline dark:text-primary-500">Sign in</a>
        </p>
    </EditForm>
</Card>

@code {
    private RegisterModel _model = new();
    private bool _isLoading;
    private string? _errorMessage;
    private EditContext? _editContext;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
    }

    private async Task HandleRegister()
    {
        _errorMessage = null;

        if (_model.Password != _model.ConfirmPassword)
        {
            _errorMessage = "Passwords do not match";
            return;
        }

        if (!_model.AcceptTerms)
        {
            _errorMessage = "You must accept the terms and conditions";
            return;
        }

        _isLoading = true;

        try
        {
            var result = await AuthClient.RegisterAsync(_model.Email!, _model.Username!, _model.Password!);

            if (result.Success)
            {
                var credentials = new StoredCredentials
                {
                    AccessToken = result.AccessToken!,
                    RefreshToken = result.RefreshToken!,
                    AccessTokenExpiry = DateTimeOffset.UtcNow.AddSeconds(result.ExpiresIn),
                    RefreshTokenExpiry = DateTimeOffset.UtcNow.AddDays(7)
                };

                await AuthStateProvider.UpdateStateAsync(credentials);
                Navigation.NavigateTo("/");
            }
            else
            {
                _errorMessage = result.ErrorMessage ?? "Registration failed";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetValidationError(string fieldName)
    {
        return _editContext?.GetValidationMessages(new FieldIdentifier(_model, fieldName)).FirstOrDefault();
    }

    private class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Username is required")]
        [System.ComponentModel.DataAnnotations.StringLength(50, MinimumLength = 3, ErrorMessage = "Username must be 3-50 characters")]
        public string? Username { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Invalid email address")]
        public string? Email { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required")]
        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters")]
        public string? Password { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your password")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string? ConfirmPassword { get; set; }

        public bool AcceptTerms { get; set; }
    }
}
