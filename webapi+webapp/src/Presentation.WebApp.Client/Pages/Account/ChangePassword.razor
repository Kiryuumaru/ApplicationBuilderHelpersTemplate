@page "/account/change-password"
@attribute [Authorize]
@inject IUserProfileClient ProfileClient
@inject IAuthStateProvider AuthStateProvider

<PageTitle>Change Password</PageTitle>

<div class="max-w-md">
    <Card>
        <h2 class="text-xl font-bold text-secondary-900 dark:text-white mb-6">Change Password</h2>
        
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <Alert Type="Alert.AlertType.Success" Message="@_successMessage" Dismissible="true" OnDismissed="() => _successMessage = null" />
        }
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" />
        }
        
        <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="change-password">
            <DataAnnotationsValidator />
            
            <TextInput Id="currentPassword" 
                       Type="password" 
                       Label="Current Password" 
                       Placeholder="••••••••" 
                       @bind-Value="_model.CurrentPassword"
                       Required="true"
                       ErrorMessage="@GetValidationError(nameof(_model.CurrentPassword))" />
            
            <TextInput Id="newPassword" 
                       Type="password" 
                       Label="New Password" 
                       Placeholder="••••••••" 
                       @bind-Value="_model.NewPassword"
                       Required="true"
                       HelperText="At least 8 characters"
                       ErrorMessage="@GetValidationError(nameof(_model.NewPassword))" />
            
            <TextInput Id="confirmPassword" 
                       Type="password" 
                       Label="Confirm New Password" 
                       Placeholder="••••••••" 
                       @bind-Value="_model.ConfirmPassword"
                       Required="true"
                       ErrorMessage="@GetValidationError(nameof(_model.ConfirmPassword))" />
            
            <Button Type="submit" Loading="_isLoading" LoadingText="Changing...">
                Change Password
            </Button>
        </EditForm>
    </Card>
</div>

@code {
    private ChangePasswordModel _model = new();
    private bool _isLoading;
    private string? _successMessage;
    private string? _errorMessage;
    private EditContext? _editContext;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
        _editContext.OnValidationStateChanged += HandleValidationStateChanged;
    }

    private void HandleValidationStateChanged(object? sender, ValidationStateChangedEventArgs e)
    {
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        _errorMessage = null;
        _successMessage = null;

        if (_model.NewPassword != _model.ConfirmPassword)
        {
            _errorMessage = "Passwords do not match";
            return;
        }

        _isLoading = true;

        try
        {
            var userId = AuthStateProvider.CurrentState.UserId;
            var (success, errorMessage) = await ProfileClient.ChangePasswordAsync(userId, _model.CurrentPassword!, _model.NewPassword!);

            if (success)
            {
                _successMessage = "Password changed successfully";
                _model = new ChangePasswordModel();
                _editContext = new EditContext(_model);
            }
            else
            {
                _errorMessage = errorMessage ?? "Failed to change password. Please check your current password.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetValidationError(string fieldName)
    {
        return _editContext?.GetValidationMessages(new FieldIdentifier(_model, fieldName)).FirstOrDefault();
    }

    private class ChangePasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Current password is required")]
        public string? CurrentPassword { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "New password is required")]
        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters")]
        public string? NewPassword { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your new password")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string? ConfirmPassword { get; set; }
    }
}
