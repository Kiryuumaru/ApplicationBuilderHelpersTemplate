@using Presentation.WebApp.Client.Components.Notifications
@using Presentation.WebApp.Client.Components.Notifications.Models

<DialogBase @bind-IsOpen="IsOpen"
            Title="Create API Key"
            Variant="DialogVariant.Primary"
            CloseOnBackdropClick="false"
            CloseOnEscape="true">
    <Icon>
        <svg class="w-6 h-6 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
        </svg>
    </Icon>
    <HeaderContent>
        <p class="text-sm text-secondary-600 dark:text-secondary-400">Create a new API key for programmatic access.</p>
    </HeaderContent>
    <BodyContent>
        <div class="space-y-4">
            <div>
                <label for="keyName" class="block mb-2 text-sm font-medium text-secondary-900 dark:text-white">Key Name</label>
                <input type="text"
                       id="keyName"
                       @ref="_nameInput"
                       @bind="_name"
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       placeholder="My API Key"
                       class="bg-secondary-50 border border-secondary-300 text-secondary-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-secondary-700 dark:border-secondary-600 dark:placeholder-secondary-400 dark:text-white" />
                <p class="mt-1 text-xs text-secondary-500 dark:text-secondary-400">A friendly name to identify this key</p>
            </div>

            <div>
                <label for="expiry" class="block mb-2 text-sm font-medium text-secondary-900 dark:text-white">Expiration</label>
                <select id="expiry"
                        @bind="_expiryDays"
                        class="bg-secondary-50 border border-secondary-300 text-secondary-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-secondary-700 dark:border-secondary-600 dark:text-white">
                    <option value="30">30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Never</option>
                </select>
            </div>
        </div>
    </BodyContent>
    <FooterContent>
        <Button Variant="Button.ButtonVariant.Secondary" OnClick="Cancel">
            Cancel
        </Button>
        <Button Variant="Button.ButtonVariant.Primary" OnClick="Submit" Disabled="@(string.IsNullOrWhiteSpace(_name))">
            Create Key
        </Button>
    </FooterContent>
</DialogBase>

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback<CreateApiKeyResult?> OnResult { get; set; }

    private string _name = "";
    private int _expiryDays = 90;
    private ElementReference _nameInput;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsOpen && string.IsNullOrEmpty(_name))
        {
            try
            {
                await _nameInput.FocusAsync();
            }
            catch
            {
                // Element may not be rendered yet
            }
        }
    }

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(_name))
            return;

        var result = new CreateApiKeyResult(_name.Trim(), _expiryDays);
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        await OnResult.InvokeAsync(result);
        ResetForm();
    }

    private async Task Cancel()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        await OnResult.InvokeAsync(null);
        ResetForm();
    }

    private void ResetForm()
    {
        _name = "";
        _expiryDays = 90;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_name))
        {
            await Submit();
        }
    }

    public record CreateApiKeyResult(string Name, int ExpiryDays);
}
