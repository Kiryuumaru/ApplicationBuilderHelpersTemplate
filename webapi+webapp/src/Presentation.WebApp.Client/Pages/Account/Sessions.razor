@page "/account/sessions"
@attribute [Authorize]
@inject ISessionsClient SessionsClient
@inject IAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Active Sessions</PageTitle>

<div class="max-w-4xl">
    <Card>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-secondary-900 dark:text-white">Active Sessions</h2>
            <Button Variant="Button.ButtonVariant.Danger" OnClick="ShowRevokeAllConfirmation" Loading="_isRevokingAll" LoadingText="Revoking...">
                Revoke All Sessions
            </Button>
        </div>
        
        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <Alert Type="Alert.AlertType.Success" Message="@_successMessage" Dismissible="true" OnDismissed="() => _successMessage = null" />
        }
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" />
        }
        
        @if (_isLoading)
        {
            <LoadingSpinner />
        }
        else if (_sessions.Count == 0)
        {
            <p class="text-secondary-500 dark:text-secondary-400">No active sessions found.</p>
        }
        else
        {
            <div class="space-y-4">
                @foreach (var session in _sessions)
                {
                    <div class="flex justify-between items-center p-4 bg-secondary-50 dark:bg-secondary-700 rounded-lg @(session.IsCurrent ? "border-2 border-primary-500" : "")">
                        <div class="flex items-center space-x-4">
                            <div class="text-2xl">
                                @GetDeviceIcon(session.UserAgent)
                            </div>
                            <div>
                                <p class="font-medium text-secondary-900 dark:text-white">
                                    @(session.DeviceName ?? session.UserAgent ?? "Unknown Device")
                                    @if (session.IsCurrent)
                                    {
                                        <span class="ml-2 text-xs bg-primary-100 text-primary-800 px-2 py-1 rounded-full dark:bg-primary-900 dark:text-primary-300">Current</span>
                                    }
                                </p>
                                <p class="text-sm text-secondary-500 dark:text-secondary-400">
                                    Created @session.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                </p>
                                <p class="text-xs text-secondary-400 dark:text-secondary-500">
                                    IP: @(session.IpAddress ?? "Unknown")
                                </p>
                            </div>
                        </div>
                        @if (!session.IsCurrent)
                        {
                            <Button Variant="Button.ButtonVariant.Secondary" Size="Button.ButtonSize.Small" OnClick="() => RevokeSession(session.Id)">
                                Revoke
                            </Button>
                        }
                    </div>
                }
            </div>
        }
    </Card>
</div>

@* Confirmation Modal for Revoke All Sessions *@
@if (_showRevokeAllConfirmation)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="CancelRevokeAll">
        <div class="bg-white dark:bg-secondary-800 rounded-lg p-6 max-w-md w-full mx-4" @onclick:stopPropagation>
            <div class="flex items-center mb-4">
                <div class="shrink-0 w-10 h-10 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-secondary-900 dark:text-white">Revoke All Sessions</h3>
            </div>
            
            <p class="text-secondary-600 dark:text-secondary-400 mb-4">
                Are you sure you want to revoke all sessions? This will log you out from all devices, <strong>including this one</strong>. You will need to log in again.
            </p>
            
            <div class="flex justify-end gap-2">
                <Button Variant="Button.ButtonVariant.Secondary" OnClick="CancelRevokeAll">
                    Cancel
                </Button>
                <Button Variant="Button.ButtonVariant.Danger" OnClick="ConfirmRevokeAllSessions" Loading="_isRevokingAll" LoadingText="Revoking...">
                    Revoke All & Log Out
                </Button>
            </div>
        </div>
    </div>
}

@code {
    private List<SessionInfo> _sessions = new();
    private bool _isLoading = true;
    private bool _isRevokingAll;
    private bool _showRevokeAllConfirmation;
    private string? _successMessage;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadSessions();
    }

    private async Task LoadSessions()
    {
        _isLoading = true;

        try
        {
            var userId = AuthStateProvider.CurrentState.UserId;
            _sessions = await SessionsClient.ListSessionsAsync(userId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load sessions: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task RevokeSession(Guid sessionId)
    {
        try
        {
            var userId = AuthStateProvider.CurrentState.UserId;
            var result = await SessionsClient.RevokeSessionAsync(userId, sessionId);
            if (result)
            {
                _successMessage = "Session revoked successfully";
                await LoadSessions();
            }
            else
            {
                _errorMessage = "Failed to revoke session";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
    }

    private void ShowRevokeAllConfirmation()
    {
        _showRevokeAllConfirmation = true;
    }

    private void CancelRevokeAll()
    {
        _showRevokeAllConfirmation = false;
    }

    private async Task ConfirmRevokeAllSessions()
    {
        _isRevokingAll = true;

        try
        {
            var userId = AuthStateProvider.CurrentState.UserId;
            await SessionsClient.RevokeAllSessionsAsync(userId);
            
            // Clear auth state and redirect to login since current session is revoked
            await AuthStateProvider.ClearStateAsync();
            Navigation.NavigateTo("/auth/login");
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
            _showRevokeAllConfirmation = false;
        }
        finally
        {
            _isRevokingAll = false;
        }
    }

    private string GetDeviceIcon(string? userAgent)
    {
        if (string.IsNullOrEmpty(userAgent))
            return "üñ•Ô∏è";
            
        var ua = userAgent.ToLowerInvariant();
        if (ua.Contains("mobile") || ua.Contains("android") || ua.Contains("iphone"))
            return "üì±";
        if (ua.Contains("tablet") || ua.Contains("ipad"))
            return "üì±";
        return "üíª";
    }
}
