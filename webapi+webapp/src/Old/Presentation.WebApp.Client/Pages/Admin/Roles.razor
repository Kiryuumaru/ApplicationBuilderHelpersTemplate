@page "/admin/roles"
@attribute [Authorize(Roles = "Admin")]
@inject Application.Client.Iam.Interfaces.IRolesClient RolesClient
@inject Application.Client.Iam.Interfaces.IPermissionsClient PermissionsClient

<PageTitle>Role Management</PageTitle>

<div class="mb-4 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Roles</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage roles and permissions</p>
    </div>
    <Button OnClick="ShowCreateModal">
        <svg class="w-4 h-4 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add Role
    </Button>
</div>

@if (_loading)
{
    <div class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
        <span class="ms-2 text-gray-600 dark:text-gray-400">Loading roles...</span>
    </div>
}
else if (_errorMessage is not null)
{
    <Alert Color="Alert.AlertColor.Red" class="mb-4">
        <span class="font-medium">Error:</span> @_errorMessage
    </Alert>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @foreach (var role in _roles)
        {
            <Card>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg @GetRoleColorClass(role.Code) flex items-center justify-center text-white font-semibold me-3">
                            @role.Name[0]
                        </div>
                        <div>
                            <h5 class="text-lg font-semibold text-gray-900 dark:text-white">@role.Name</h5>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@role.Code</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button @onclick="() => EditRole(role)" class="p-2 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white" title="Edit">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        @if (!role.IsSystemRole)
                        {
                            <button @onclick="() => ConfirmDeleteRole(role)" class="p-2 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        }
                        else
                        {
                            <span class="p-2 text-gray-300 dark:text-gray-600" title="System roles cannot be deleted">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </span>
                        }
                    </div>
                </div>
                
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">@(role.Description ?? "No description")</p>
                
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h6 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Scope Templates</h6>
                    <div class="flex flex-wrap gap-1">
                        @if (role.ScopeTemplates.Count == 0)
                        {
                            <span class="text-sm text-gray-400 italic">No scope templates</span>
                        }
                        else
                        {
                            @foreach (var scope in role.ScopeTemplates.Take(5))
                            {
                                <span class="@(scope.IsAllow ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300" : "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300") text-xs font-medium px-2 py-0.5 rounded">
                                    @(scope.IsAllow ? "✓" : "✗") @scope.PermissionIdentifier
                                </span>
                            }
                            @if (role.ScopeTemplates.Count > 5)
                            {
                                <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300">
                                    +@(role.ScopeTemplates.Count - 5) more
                                </span>
                            }
                        }
                    </div>
                </div>
            </Card>
        }
    </div>
}

@* Create/Edit Modal *@
@if (_showModal)
{
    <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @onclick="CloseModal"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full dark:bg-gray-800">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        @(_editingRole is null ? "Create Role" : "Edit Role")
                    </h3>
                    
                    @if (_modalError is not null)
                    {
                        <Alert Color="Alert.AlertColor.Red" class="mb-4">@_modalError</Alert>
                    }
                    
                    <div class="space-y-4">
                        @if (_editingRole is null)
                        {
                            <TextInput @bind-Value="_formCode" Label="Code" Placeholder="e.g., manager, viewer" Required="true" />
                        }
                        else
                        {
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Code</label>
                                <p class="text-gray-900 dark:text-white">@_editingRole.Code</p>
                            </div>
                        }
                        <TextInput @bind-Value="_formName" Label="Name" Placeholder="e.g., Manager" Required="true" />
                        <TextInput @bind-Value="_formDescription" Label="Description" Placeholder="Description of this role" />
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <Button OnClick="SaveRole" Disabled="_saving">
                        @if (_saving)
                        {
                            <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white me-2"></span>
                        }
                        @(_editingRole is null ? "Create" : "Save")
                    </Button>
                    <Button Color="Button.ButtonColor.Alternative" OnClick="CloseModal" Disabled="_saving">Cancel</Button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (_showDeleteModal && _roleToDelete is not null)
{
    <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @onclick="CloseDeleteModal"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full dark:bg-gray-800">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Delete Role</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Are you sure you want to delete the role <strong>@_roleToDelete.Name</strong>? 
                                    Users assigned this role will lose its permissions. This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <Button Color="Button.ButtonColor.Red" OnClick="DeleteRole" Disabled="_deleting">
                        @if (_deleting)
                        {
                            <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white me-2"></span>
                        }
                        Delete
                    </Button>
                    <Button Color="Button.ButtonColor.Alternative" OnClick="CloseDeleteModal" Disabled="_deleting">Cancel</Button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Application.Client.Iam.Models.IamRole> _roles = new();
    private bool _loading = true;
    private string? _errorMessage;
    
    // Modal state
    private bool _showModal;
    private bool _saving;
    private string? _modalError;
    private Application.Client.Iam.Models.IamRole? _editingRole;
    
    // Form fields
    private string _formCode = string.Empty;
    private string _formName = string.Empty;
    private string _formDescription = string.Empty;
    
    // Delete modal state
    private bool _showDeleteModal;
    private bool _deleting;
    private Application.Client.Iam.Models.IamRole? _roleToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        _loading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            _roles = await RolesClient.ListRolesAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load roles: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private string GetRoleColorClass(string roleCode) => roleCode.ToLowerInvariant() switch
    {
        "admin" => "bg-red-600",
        "user" => "bg-primary-600",
        "manager" => "bg-yellow-500",
        _ => "bg-gray-600"
    };

    private void ShowCreateModal()
    {
        _editingRole = null;
        _formCode = string.Empty;
        _formName = string.Empty;
        _formDescription = string.Empty;
        _modalError = null;
        _showModal = true;
    }

    private void EditRole(Application.Client.Iam.Models.IamRole role)
    {
        _editingRole = role;
        _formCode = role.Code;
        _formName = role.Name;
        _formDescription = role.Description ?? string.Empty;
        _modalError = null;
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
        _editingRole = null;
        _modalError = null;
    }

    private async Task SaveRole()
    {
        if (string.IsNullOrWhiteSpace(_formName))
        {
            _modalError = "Name is required.";
            return;
        }

        _saving = true;
        _modalError = null;
        StateHasChanged();

        try
        {
            if (_editingRole is null)
            {
                // Create new role
                if (string.IsNullOrWhiteSpace(_formCode))
                {
                    _modalError = "Code is required.";
                    _saving = false;
                    return;
                }

                var request = new Application.Client.Iam.Models.CreateRoleRequest
                {
                    Code = _formCode,
                    Name = _formName,
                    Description = string.IsNullOrWhiteSpace(_formDescription) ? null : _formDescription
                };

                var created = await RolesClient.CreateRoleAsync(request);
                if (created is null)
                {
                    _modalError = "Failed to create role. The code may already exist.";
                    _saving = false;
                    return;
                }
            }
            else
            {
                // Update existing role
                var request = new Application.Client.Iam.Models.UpdateRoleRequest
                {
                    Name = _formName,
                    Description = string.IsNullOrWhiteSpace(_formDescription) ? null : _formDescription
                };

                var updated = await RolesClient.UpdateRoleAsync(_editingRole.Id, request);
                if (updated is null)
                {
                    _modalError = "Failed to update role.";
                    _saving = false;
                    return;
                }
            }

            CloseModal();
            await LoadRoles();
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private void ConfirmDeleteRole(Application.Client.Iam.Models.IamRole role)
    {
        _roleToDelete = role;
        _showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        _showDeleteModal = false;
        _roleToDelete = null;
    }

    private async Task DeleteRole()
    {
        if (_roleToDelete is null) return;

        _deleting = true;
        StateHasChanged();

        try
        {
            var success = await RolesClient.DeleteRoleAsync(_roleToDelete.Id);
            if (!success)
            {
                _errorMessage = "Failed to delete role.";
            }

            CloseDeleteModal();
            await LoadRoles();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error deleting role: {ex.Message}";
        }
        finally
        {
            _deleting = false;
        }
    }
}
