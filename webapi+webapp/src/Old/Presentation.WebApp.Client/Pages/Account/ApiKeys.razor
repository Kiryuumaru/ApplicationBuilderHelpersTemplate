@page "/account/api-keys"
@attribute [Authorize]
@inject IApiKeysClient ApiKeysClient
@inject IAuthStateProvider AuthStateProvider
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>API Keys</PageTitle>

<div class="mb-4">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="account/profile" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600 dark:text-gray-400 dark:hover:text-white">
                    Profile
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">API Keys</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="mb-4 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">API Keys</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage API keys for programmatic access</p>
    </div>
    <Button OnClick="ShowCreateModal">
        <svg class="w-4 h-4 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Create API Key
    </Button>
</div>

@if (!string.IsNullOrEmpty(_successMessage))
{
    <Alert Type="Alert.AlertType.Success" Message="@_successMessage" Dismissible="true" OnDismissed="() => _successMessage = null" class="mb-4" />
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" class="mb-4" />
}

@if (_newApiKey != null)
{
    <Card class="mb-4 border-2 border-yellow-500 dark:border-yellow-600">
        <div class="flex items-start space-x-4">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900 flex items-center justify-center">
                    <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
            <div class="flex-grow">
                <h4 class="text-sm font-medium text-gray-900 dark:text-white">API Key Created Successfully</h4>
                <p class="text-sm text-yellow-600 dark:text-yellow-400 mt-1">
                    <strong>Important:</strong> Copy your API key now. You won't be able to see it again!
                </p>
                <div class="mt-3 flex items-center space-x-2">
                    <code class="flex-grow px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded text-sm font-mono break-all">
                        @_newApiKey.Key
                    </code>
                    <Button Size="Button.ButtonSize.Small" OnClick="CopyApiKey">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </Button>
                </div>
                <div class="mt-3">
                    <Button Size="Button.ButtonSize.Small" Color="Button.ButtonColor.Gray" OnClick="() => _newApiKey = null">
                        Dismiss
                    </Button>
                </div>
            </div>
        </div>
    </Card>
}

<Card Padding="p-0">
    @if (_isLoading)
    {
        <div class="p-8 text-center">
            <svg class="animate-spin h-8 w-8 text-primary-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-500 dark:text-gray-400">Loading API keys...</p>
        </div>
    }
    else if (_apiKeys.Count == 0)
    {
        <div class="p-8 text-center">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            <p class="text-gray-500 dark:text-gray-400">No API keys yet</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Create an API key to access the API programmatically</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">Name</th>
                        <th scope="col" class="px-6 py-3">Created</th>
                        <th scope="col" class="px-6 py-3">Expires</th>
                        <th scope="col" class="px-6 py-3">Last Used</th>
                        <th scope="col" class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var apiKey in _apiKeys)
                    {
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-gray-400 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                    <span class="font-medium text-gray-900 dark:text-white">@apiKey.Name</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">@apiKey.CreatedAt.ToString("MMM dd, yyyy")</td>
                            <td class="px-6 py-4">
                                @if (apiKey.ExpiresAt.HasValue)
                                {
                                    var isExpired = apiKey.ExpiresAt.Value < DateTimeOffset.UtcNow;
                                    <span class="@(isExpired ? "text-red-600 dark:text-red-400" : "")">
                                        @apiKey.ExpiresAt.Value.ToString("MMM dd, yyyy")
                                        @if (isExpired)
                                        {
                                            <span class="text-xs">(Expired)</span>
                                        }
                                    </span>
                                }
                                else
                                {
                                    <span class="text-gray-400">Never</span>
                                }
                            </td>
                            <td class="px-6 py-4">
                                @if (apiKey.LastUsedAt.HasValue)
                                {
                                    @FormatRelativeTime(apiKey.LastUsedAt.Value)
                                }
                                else
                                {
                                    <span class="text-gray-400">Never</span>
                                }
                            </td>
                            <td class="px-6 py-4">
                                <Button Color="Button.ButtonColor.Red" 
                                        Size="Button.ButtonSize.Small"
                                        OnClick="() => RevokeApiKey(apiKey)"
                                        Loading="_revokingApiKeyId == apiKey.Id"
                                        LoadingText="Revoking...">
                                    Revoke
                                </Button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</Card>

<Card Title="About API Keys" class="mt-4">
    <div class="text-sm text-gray-500 dark:text-gray-400 space-y-2">
        <p>
            <strong>What are API keys?</strong> API keys allow you to access the API programmatically without needing to log in interactively.
            They are useful for scripts, automation, and integrations.
        </p>
        <p>
            <strong>Security considerations:</strong>
        </p>
        <ul class="list-disc list-inside ml-4 space-y-1">
            <li>API keys have the same permissions as your account</li>
            <li>Store them securely and never share them publicly</li>
            <li>Set an expiration date for added security</li>
            <li>Revoke keys immediately if you suspect they've been compromised</li>
        </ul>
        <p>
            <strong>Usage:</strong> Include the key in your API requests using the <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">Authorization: Bearer YOUR_KEY</code> header.
        </p>
    </div>
</Card>

@* Create API Key Modal *@
@if (_showCreateModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="HideCreateModal">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4" @onclick:stopPropagation>
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Create API Key</h3>
            </div>
            <EditForm Model="_createModel" OnValidSubmit="CreateApiKey" FormName="create-api-key">
                <DataAnnotationsValidator />
                <div class="p-4 space-y-4">
                    <TextInput Id="name" 
                               Type="text" 
                               Label="Name" 
                               @bind-Value="_createModel.Name"
                               Placeholder="e.g., CI/CD Pipeline"
                               Required="true" />
                    
                    <div>
                        <label for="expiresAt" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                            Expiration (optional)
                        </label>
                        <input type="date" 
                               id="expiresAt" 
                               @bind="_createModel.ExpiresAt"
                               class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" />
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave empty for no expiration</p>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2">
                    <Button Type="button" Color="Button.ButtonColor.Gray" OnClick="HideCreateModal">Cancel</Button>
                    <Button Type="submit" Loading="_isCreating" LoadingText="Creating...">Create</Button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private AuthState _authState = AuthState.Anonymous;
    private List<ApiKeyInfo> _apiKeys = new();
    private bool _isLoading = true;
    private bool _isCreating;
    private Guid? _revokingApiKeyId;
    private string? _successMessage;
    private string? _errorMessage;
    private bool _showCreateModal;
    private CreateApiKeyModel _createModel = new();
    private CreateApiKeyResult? _newApiKey;

    protected override async Task OnInitializedAsync()
    {
        _authState = AuthStateProvider.CurrentState;
        AuthStateProvider.OnStateChanged += HandleAuthStateChanged;
        
        await LoadApiKeys();
    }

    private async void HandleAuthStateChanged()
    {
        _authState = AuthStateProvider.CurrentState;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadApiKeys()
    {
        if (_authState.UserId == Guid.Empty) return;
        
        _isLoading = true;
        try
        {
            _apiKeys = await ApiKeysClient.ListApiKeysAsync(_authState.UserId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load API keys: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowCreateModal()
    {
        _createModel = new();
        _showCreateModal = true;
    }

    private void HideCreateModal()
    {
        _showCreateModal = false;
    }

    private async Task CreateApiKey()
    {
        _isCreating = true;
        _errorMessage = null;

        try
        {
            DateTimeOffset? expiresAt = null;
            if (_createModel.ExpiresAt.HasValue)
            {
                expiresAt = new DateTimeOffset(_createModel.ExpiresAt.Value, TimeSpan.Zero);
            }

            var result = await ApiKeysClient.CreateApiKeyAsync(_authState.UserId, _createModel.Name!, expiresAt);
            
            if (result != null)
            {
                _newApiKey = result;
                _showCreateModal = false;
                await LoadApiKeys();
                _successMessage = "API key created successfully. Copy it now!";
            }
            else
            {
                _errorMessage = "Failed to create API key";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to create API key: {ex.Message}";
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task RevokeApiKey(ApiKeyInfo apiKey)
    {
        _revokingApiKeyId = apiKey.Id;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var success = await ApiKeysClient.RevokeApiKeyAsync(_authState.UserId, apiKey.Id);
            if (success)
            {
                _apiKeys.Remove(apiKey);
                _successMessage = "API key revoked successfully";
            }
            else
            {
                _errorMessage = "Failed to revoke API key";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to revoke API key: {ex.Message}";
        }
        finally
        {
            _revokingApiKeyId = null;
        }
    }

    private async Task CopyApiKey()
    {
        if (_newApiKey != null)
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _newApiKey.Key);
            _successMessage = "API key copied to clipboard!";
        }
    }

    private string FormatRelativeTime(DateTimeOffset dateTime)
    {
        var now = DateTimeOffset.UtcNow;
        var diff = now - dateTime;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} minutes ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hours ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays} days ago";
        
        return dateTime.ToString("MMM dd, yyyy");
    }

    public void Dispose()
    {
        AuthStateProvider.OnStateChanged -= HandleAuthStateChanged;
    }

    private class CreateApiKeyModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Name is required")]
        [System.ComponentModel.DataAnnotations.StringLength(100, ErrorMessage = "Name cannot exceed 100 characters")]
        public string? Name { get; set; }

        public DateTime? ExpiresAt { get; set; }
    }
}
