@page "/account/sessions"
@attribute [Authorize]
@inject ISessionsClient SessionsClient
@inject IAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Active Sessions</PageTitle>

<div class="mb-4">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="account/profile" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600 dark:text-gray-400 dark:hover:text-white">
                    Profile
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">Active Sessions</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="mb-4 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Active Sessions</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage your active login sessions across devices</p>
    </div>
    @if (_sessions.Count > 1)
    {
        <Button Color="Button.ButtonColor.Red" OnClick="RevokeAllOtherSessions" Loading="_isRevokingAll" LoadingText="Revoking...">
            <svg class="w-4 h-4 me-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Revoke All Other Sessions
        </Button>
    }
</div>

@if (!string.IsNullOrEmpty(_successMessage))
{
    <Alert Type="Alert.AlertType.Success" Message="@_successMessage" Dismissible="true" OnDismissed="() => _successMessage = null" class="mb-4" />
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" class="mb-4" />
}

<Card Padding="p-0">
    @if (_isLoading)
    {
        <div class="p-8 text-center">
            <svg class="animate-spin h-8 w-8 text-primary-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-500 dark:text-gray-400">Loading sessions...</p>
        </div>
    }
    else if (_sessions.Count == 0)
    {
        <div class="p-8 text-center">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <p class="text-gray-500 dark:text-gray-400">No active sessions found</p>
        </div>
    }
    else
    {
        <div class="divide-y divide-gray-200 dark:divide-gray-700">
            @foreach (var session in _sessions)
            {
                <div class="p-4 @(session.IsCurrent ? "bg-primary-50 dark:bg-primary-900/20" : "") hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                @if (GetDeviceIcon(session.UserAgent) == "desktop")
                                {
                                    <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                }
                                else
                                {
                                    <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                }
                            </div>
                            <div>
                                <div class="flex items-center space-x-2">
                                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">
                                        @(session.DeviceName ?? ParseBrowserName(session.UserAgent))
                                    </h4>
                                    @if (session.IsCurrent)
                                    {
                                        <span class="bg-primary-100 text-primary-800 text-xs font-medium px-2 py-0.5 rounded dark:bg-primary-900 dark:text-primary-300">
                                            Current Session
                                        </span>
                                    }
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    @(session.IpAddress ?? "Unknown IP")
                                </p>
                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                    @if (session.LastUsedAt.HasValue)
                                    {
                                        <span>Last active: @FormatRelativeTime(session.LastUsedAt.Value)</span>
                                    }
                                    else
                                    {
                                        <span>Created: @FormatRelativeTime(session.CreatedAt)</span>
                                    }
                                </p>
                            </div>
                        </div>
                        @if (!session.IsCurrent)
                        {
                            <Button Color="Button.ButtonColor.Red" 
                                    Size="Button.ButtonSize.Small"
                                    OnClick="() => RevokeSession(session)"
                                    Loading="_revokingSessionId == session.Id"
                                    LoadingText="Revoking...">
                                Revoke
                            </Button>
                        }
                    </div>
                </div>
            }
        </div>
    }
</Card>

<Card Title="About Sessions" class="mt-4">
    <div class="text-sm text-gray-500 dark:text-gray-400 space-y-2">
        <p>
            <strong>What are sessions?</strong> A session is created each time you log in from a device or browser.
            Each session allows you to stay logged in without entering your password again.
        </p>
        <p>
            <strong>Why revoke sessions?</strong> If you notice any unfamiliar sessions, you should revoke them immediately.
            This logs out that device and prevents further access. Also revoke sessions if you've logged in on a shared computer.
        </p>
        <p>
            <strong>Note:</strong> Revoking your current session will log you out.
        </p>
    </div>
</Card>

@code {
    private AuthState _authState = AuthState.Anonymous;
    private List<SessionInfo> _sessions = new();
    private bool _isLoading = true;
    private bool _isRevokingAll;
    private Guid? _revokingSessionId;
    private string? _successMessage;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        _authState = AuthStateProvider.CurrentState;
        AuthStateProvider.OnStateChanged += HandleAuthStateChanged;
        
        await LoadSessions();
    }

    private async void HandleAuthStateChanged()
    {
        _authState = AuthStateProvider.CurrentState;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadSessions()
    {
        if (_authState.UserId == Guid.Empty) return;
        
        _isLoading = true;
        try
        {
            _sessions = await SessionsClient.ListSessionsAsync(_authState.UserId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load sessions: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task RevokeSession(SessionInfo session)
    {
        _revokingSessionId = session.Id;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var success = await SessionsClient.RevokeSessionAsync(_authState.UserId, session.Id);
            if (success)
            {
                _sessions.Remove(session);
                _successMessage = "Session revoked successfully";
            }
            else
            {
                _errorMessage = "Failed to revoke session";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to revoke session: {ex.Message}";
        }
        finally
        {
            _revokingSessionId = null;
        }
    }

    private async Task RevokeAllOtherSessions()
    {
        _isRevokingAll = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var count = await SessionsClient.RevokeAllSessionsAsync(_authState.UserId);
            if (count > 0)
            {
                _successMessage = $"Revoked {count} session(s)";
                await LoadSessions();
            }
            else
            {
                _errorMessage = "No sessions were revoked";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to revoke sessions: {ex.Message}";
        }
        finally
        {
            _isRevokingAll = false;
        }
    }

    private string GetDeviceIcon(string? userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "desktop";
        
        var ua = userAgent.ToLowerInvariant();
        if (ua.Contains("mobile") || ua.Contains("android") || ua.Contains("iphone") || ua.Contains("ipad"))
            return "mobile";
        
        return "desktop";
    }

    private string ParseBrowserName(string? userAgent)
    {
        if (string.IsNullOrEmpty(userAgent)) return "Unknown Browser";
        
        var ua = userAgent.ToLowerInvariant();
        if (ua.Contains("edg/")) return "Microsoft Edge";
        if (ua.Contains("chrome")) return "Google Chrome";
        if (ua.Contains("firefox")) return "Mozilla Firefox";
        if (ua.Contains("safari") && !ua.Contains("chrome")) return "Safari";
        if (ua.Contains("opera") || ua.Contains("opr/")) return "Opera";
        
        return "Unknown Browser";
    }

    private string FormatRelativeTime(DateTimeOffset dateTime)
    {
        var now = DateTimeOffset.UtcNow;
        var diff = now - dateTime;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} minutes ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hours ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays} days ago";
        
        return dateTime.ToString("MMM dd, yyyy");
    }

    public void Dispose()
    {
        AuthStateProvider.OnStateChanged -= HandleAuthStateChanged;
    }
}
