@page "/account/change-password"
@attribute [Authorize]
@inject NavigationManager Navigation
@inject IUserProfileClient UserProfileClient
@inject IAuthStateProvider AuthStateProvider
@implements IDisposable

<PageTitle>Change Password</PageTitle>

<div class="mb-4">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="account/profile" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600 dark:text-gray-400 dark:hover:text-white">
                    Profile
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">Change Password</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="max-w-xl">
    <Card Title="Change Password">
        @if (_success)
        {
            <Alert Type="Alert.AlertType.Success" Title="Password changed!" Message="Your password has been successfully updated." />
            
            <div class="mt-4">
                <Button OnClick="@(() => Navigation.NavigateTo("account/profile"))">
                    Back to Profile
                </Button>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" />
            }
            
            <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="change-password">
                <DataAnnotationsValidator />
                
                <TextInput Id="currentPassword" 
                           Type="password" 
                           Label="Current password" 
                           Placeholder="••••••••" 
                           @bind-Value="_model.CurrentPassword"
                           Required="true"
                           ErrorMessage="@GetValidationError(nameof(_model.CurrentPassword))" />
                
                <TextInput Id="newPassword" 
                           Type="password" 
                           Label="New password" 
                           Placeholder="••••••••" 
                           @bind-Value="_model.NewPassword"
                           Required="true"
                           HelperText="At least 8 characters"
                           ErrorMessage="@GetValidationError(nameof(_model.NewPassword))" />
                
                <TextInput Id="confirmPassword" 
                           Type="password" 
                           Label="Confirm new password" 
                           Placeholder="••••••••" 
                           @bind-Value="_model.ConfirmPassword"
                           Required="true"
                           ErrorMessage="@GetValidationError(nameof(_model.ConfirmPassword))" />
                
                <div class="flex justify-end space-x-2 mt-4">
                    <Button Variant="Button.ButtonVariant.Secondary" OnClick="@(() => Navigation.NavigateTo("account/profile"))">
                        Cancel
                    </Button>
                    <Button Type="submit" Loading="_isLoading" LoadingText="Updating...">
                        Update Password
                    </Button>
                </div>
            </EditForm>
        }
    </Card>
</div>

@code {
    private AuthState _authState = AuthState.Anonymous;
    private ChangePasswordModel _model = new();
    private bool _isLoading;
    private bool _success;
    private string? _errorMessage;
    private EditContext? _editContext;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_model);
        _authState = AuthStateProvider.CurrentState;
        AuthStateProvider.OnStateChanged += HandleAuthStateChanged;
    }

    private void HandleAuthStateChanged()
    {
        _authState = AuthStateProvider.CurrentState;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleSubmit()
    {
        _errorMessage = null;

        if (_model.NewPassword != _model.ConfirmPassword)
        {
            _errorMessage = "New passwords do not match";
            return;
        }

        if (_authState.UserId == Guid.Empty)
        {
            _errorMessage = "User not authenticated";
            return;
        }

        _isLoading = true;

        try
        {
            var (success, errorMessage) = await UserProfileClient.ChangePasswordAsync(
                _authState.UserId, 
                _model.CurrentPassword!, 
                _model.NewPassword!);

            if (success)
            {
                _success = true;
            }
            else
            {
                _errorMessage = errorMessage ?? "Failed to change password";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to change password: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? GetValidationError(string fieldName)
    {
        return _editContext?.GetValidationMessages(new FieldIdentifier(_model, fieldName)).FirstOrDefault();
    }

    public void Dispose()
    {
        AuthStateProvider.OnStateChanged -= HandleAuthStateChanged;
    }

    private class ChangePasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Current password is required")]
        public string? CurrentPassword { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "New password is required")]
        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters")]
        public string? NewPassword { get; set; }

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your new password")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string? ConfirmPassword { get; set; }
    }
}
