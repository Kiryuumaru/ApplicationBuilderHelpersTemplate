@page "/admin/users"
@attribute [Authorize(Roles = "Admin")]
@inject IUsersClient UsersClient
@inject IRolesClient RolesClient

<PageTitle>User Management</PageTitle>

<div class="mb-4 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Users</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage user accounts</p>
    </div>
</div>

@if (!string.IsNullOrEmpty(_successMessage))
{
    <Alert Type="Alert.AlertType.Success" Message="@_successMessage" Dismissible="true" OnDismissed="() => _successMessage = null" class="mb-4" />
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <Alert Type="Alert.AlertType.Error" Message="@_errorMessage" Dismissible="true" OnDismissed="() => _errorMessage = null" class="mb-4" />
}

<Card Padding="p-0">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-2 md:space-y-0">
            <div class="relative w-full md:w-64">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="search" 
                       @bind="_searchQuery" 
                       @bind:event="oninput"
                       class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" 
                       placeholder="Search users..." />
            </div>
            <div class="flex items-center space-x-2">
                <Button Size="Button.ButtonSize.Small" Color="Button.ButtonColor.Gray" OnClick="LoadUsers" Loading="_isLoading" LoadingText="Refreshing...">
                    <svg class="w-4 h-4 me-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </Button>
            </div>
        </div>
    </div>
    
    @if (_isLoading)
    {
        <div class="p-8 text-center">
            <svg class="animate-spin h-8 w-8 text-primary-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-500 dark:text-gray-400">Loading users...</p>
        </div>
    }
    else if (_users.Count == 0)
    {
        <div class="p-8 text-center">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <p class="text-gray-500 dark:text-gray-400">No users found</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">User</th>
                        <th scope="col" class="px-6 py-3">Status</th>
                        <th scope="col" class="px-6 py-3">2FA</th>
                        <th scope="col" class="px-6 py-3">Roles</th>
                        <th scope="col" class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in FilteredUsers)
                    {
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-primary-600 flex items-center justify-center text-white font-semibold me-3">
                                        @GetUserInitial(user)
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900 dark:text-white">@(user.Username ?? "No username")</div>
                                        <div class="text-gray-500 dark:text-gray-400">@(user.Email ?? "No email")</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    @if (user.IsLockedOut)
                                    {
                                        <div class="h-2.5 w-2.5 rounded-full bg-red-500 me-2"></div>
                                        <span>Locked</span>
                                    }
                                    else
                                    {
                                        <div class="h-2.5 w-2.5 rounded-full bg-green-500 me-2"></div>
                                        <span>Active</span>
                                    }
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                @if (user.TwoFactorEnabled)
                                {
                                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Enabled</span>
                                }
                                else
                                {
                                    <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300">Disabled</span>
                                }
                            </td>
                            <td class="px-6 py-4">
                                @{
                                    var roleNames = GetRoleNames(user.RoleIds);
                                }
                                @if (roleNames.Any())
                                {
                                    @foreach (var role in roleNames)
                                    {
                                        <span class="@GetRoleBadgeClass(role) me-1">@role</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-gray-400">No roles</span>
                                }
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-2">
                                    <button @onclick="() => ShowEditModal(user)" class="font-medium text-primary-600 dark:text-primary-500 hover:underline">Edit</button>
                                    <button @onclick="() => ShowDeleteModal(user)" class="font-medium text-red-600 dark:text-red-500 hover:underline">Delete</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    
    <div class="p-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-500 dark:text-gray-400">
                Showing <span class="font-semibold text-gray-900 dark:text-white">@FilteredUsers.Count()</span> of <span class="font-semibold text-gray-900 dark:text-white">@_users.Count</span> users
            </span>
        </div>
    </div>
</Card>

@* Edit User Modal *@
@if (_showEditModal && _editingUser != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="HideEditModal">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4" @onclick:stopPropagation>
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Edit User</h3>
            </div>
            <div class="p-4 space-y-4">
                <TextInput Id="editEmail" 
                           Type="email" 
                           Label="Email" 
                           @bind-Value="_editEmail" />
                
                <TextInput Id="editPhone" 
                           Type="tel" 
                           Label="Phone Number" 
                           @bind-Value="_editPhone" />
                
                <div class="flex items-center">
                    <input id="editLockout" type="checkbox" @bind="_editLockoutEnabled" class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label for="editLockout" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Lockout Enabled</label>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2">
                <Button Type="button" Color="Button.ButtonColor.Gray" OnClick="HideEditModal">Cancel</Button>
                <Button Type="button" OnClick="SaveUser" Loading="_isSaving" LoadingText="Saving...">Save</Button>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (_showDeleteModal && _deletingUser != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="HideDeleteModal">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4" @onclick:stopPropagation>
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Delete User</h3>
            </div>
            <div class="p-4">
                <p class="text-gray-500 dark:text-gray-400">
                    Are you sure you want to delete user <strong>@(_deletingUser.Username ?? _deletingUser.Email)</strong>? This action cannot be undone.
                </p>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2">
                <Button Type="button" Color="Button.ButtonColor.Gray" OnClick="HideDeleteModal">Cancel</Button>
                <Button Type="button" Color="Button.ButtonColor.Red" OnClick="DeleteUser" Loading="_isDeleting" LoadingText="Deleting...">Delete</Button>
            </div>
        </div>
    </div>
}

@code {
    private string _searchQuery = "";
    private List<IamUser> _users = new();
    private List<IamRole> _roles = new();
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isDeleting;
    private string? _successMessage;
    private string? _errorMessage;
    
    // Edit modal
    private bool _showEditModal;
    private IamUser? _editingUser;
    private string? _editEmail;
    private string? _editPhone;
    private bool _editLockoutEnabled;
    
    // Delete modal
    private bool _showDeleteModal;
    private IamUser? _deletingUser;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await LoadRoles();
    }

    private async Task LoadUsers()
    {
        _isLoading = true;
        try
        {
            _users = await UsersClient.ListUsersAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load users: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadRoles()
    {
        try
        {
            _roles = await RolesClient.ListRolesAsync();
        }
        catch
        {
            // Ignore role loading errors
        }
    }

    private IEnumerable<IamUser> FilteredUsers => _users
        .Where(u => string.IsNullOrEmpty(_searchQuery) || 
                    (u.Username?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (u.Email?.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ?? false));

    private string GetUserInitial(IamUser user)
    {
        if (!string.IsNullOrEmpty(user.Username))
            return user.Username[0].ToString().ToUpper();
        if (!string.IsNullOrEmpty(user.Email))
            return user.Email[0].ToString().ToUpper();
        return "U";
    }

    private List<string> GetRoleNames(List<Guid> roleIds)
    {
        return _roles
            .Where(r => roleIds.Contains(r.Id))
            .Select(r => r.Name)
            .ToList();
    }

    private string GetRoleBadgeClass(string role) => role.ToLowerInvariant() switch
    {
        "admin" or "administrator" => "bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-300",
        _ => "bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300"
    };

    private void ShowEditModal(IamUser user)
    {
        _editingUser = user;
        _editEmail = user.Email;
        _editPhone = user.PhoneNumber;
        _editLockoutEnabled = user.LockoutEnabled;
        _showEditModal = true;
    }

    private void HideEditModal()
    {
        _showEditModal = false;
        _editingUser = null;
    }

    private async Task SaveUser()
    {
        if (_editingUser == null) return;

        _isSaving = true;
        _errorMessage = null;

        try
        {
            var result = await UsersClient.UpdateUserAsync(_editingUser.Id, new Application.Client.Iam.Models.UpdateUserRequest
            {
                Email = _editEmail,
                PhoneNumber = _editPhone,
                LockoutEnabled = _editLockoutEnabled
            });

            if (result != null)
            {
                _successMessage = "User updated successfully";
                _showEditModal = false;
                await LoadUsers();
            }
            else
            {
                _errorMessage = "Failed to update user";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to update user: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ShowDeleteModal(IamUser user)
    {
        _deletingUser = user;
        _showDeleteModal = true;
    }

    private void HideDeleteModal()
    {
        _showDeleteModal = false;
        _deletingUser = null;
    }

    private async Task DeleteUser()
    {
        if (_deletingUser == null) return;

        _isDeleting = true;
        _errorMessage = null;

        try
        {
            var success = await UsersClient.DeleteUserAsync(_deletingUser.Id);
            
            if (success)
            {
                _successMessage = "User deleted successfully";
                _showDeleteModal = false;
                _users.Remove(_deletingUser);
            }
            else
            {
                _errorMessage = "Failed to delete user";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to delete user: {ex.Message}";
        }
        finally
        {
            _isDeleting = false;
        }
    }
}
