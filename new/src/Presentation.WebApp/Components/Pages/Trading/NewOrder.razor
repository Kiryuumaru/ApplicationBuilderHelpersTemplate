@page "/trading/orders/new"
@using Application.Trading.Interfaces
@using Domain.Trading.Enums
@using Domain.Trading.Entities
@using Domain.Trading.ValueObjects
@inject IExchangeService ExchangeService
@inject IExchangeAccountStore ExchangeAccountStore
@inject IExchangeRegistry ExchangeRegistry
@inject IOrderStore OrderStore
@inject NavigationManager NavigationManager
@inject ILogger<NewOrder> Logger
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>New Order</PageTitle>

<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/trading">Trading</a></li>
                    <li class="breadcrumb-item"><a href="/trading/orders">Orders</a></li>
                    <li class="breadcrumb-item active">New Order</li>
                </ol>
            </nav>
            <h1>
                <span class="bi bi-plus-lg me-2"></span>Place New Order
            </h1>
        </div>
    </div>

    @if (!_accounts.Any())
    {
        <div class="alert alert-warning">
            <span class="bi bi-exclamation-triangle me-2"></span>
            You need to <a href="/trading/accounts">add an exchange account</a> before placing orders.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Order Details</h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="_formModel" OnValidSubmit="SubmitOrderAsync">
                            <DataAnnotationsValidator />

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Exchange Account</label>
                                    <InputSelect class="form-select" @bind-Value="_formModel.AccountId">
                                        <option value="">Select account...</option>
                                        @foreach (var account in _accounts.Where(a => a.Status == ExchangeAccountStatus.Connected || a.Status == ExchangeAccountStatus.CredentialsPresent))
                                        {
                                            <option value="@account.Id">@account.Name (@account.ExchangeCode)</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Base Asset</label>
                                    <InputText class="form-control text-uppercase" @bind-Value="_formModel.BaseAsset"
                                               placeholder="BTC" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quote Asset</label>
                                    <InputText class="form-control text-uppercase" @bind-Value="_formModel.QuoteAsset"
                                               placeholder="USDT" />
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-primary w-100" 
                                            @onclick="FetchCurrentPriceAsync" disabled="@_isFetchingPrice">
                                        @if (_isFetchingPrice)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        <span class="bi bi-arrow-clockwise me-1"></span>Get Price
                                    </button>
                                </div>
                            </div>

                            @if (_currentPrice != null)
                            {
                                <div class="alert alert-info mb-3">
                                    <span class="bi bi-info-circle me-2"></span>
                                    Current Price: <strong>@FormatPrice(_currentPrice.Value)</strong> @_formModel.QuoteAsset
                                </div>
                            }

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Side</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="side" id="sideBuy" 
                                               checked="@(_formModel.Side == "Buy")" 
                                               @onchange='() => _formModel.Side = "Buy"' />
                                        <label class="btn btn-outline-success" for="sideBuy">
                                            <span class="bi bi-arrow-up me-1"></span>Buy
                                        </label>

                                        <input type="radio" class="btn-check" name="side" id="sideSell"
                                               checked="@(_formModel.Side == "Sell")"
                                               @onchange='() => _formModel.Side = "Sell"' />
                                        <label class="btn btn-outline-danger" for="sideSell">
                                            <span class="bi bi-arrow-down me-1"></span>Sell
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Order Type</label>
                                    <InputSelect class="form-select" @bind-Value="_formModel.OrderType">
                                        <option value="Limit">Limit</option>
                                        <option value="Market">Market</option>
                                    </InputSelect>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Quantity (@_formModel.BaseAsset.ToUpperInvariant())</label>
                                    <InputNumber class="form-control" @bind-Value="_formModel.Quantity" />
                                    <small class="text-muted">Amount of @_formModel.BaseAsset.ToUpperInvariant() to @_formModel.Side.ToLower()</small>
                                </div>
                                <div class="col-md-6">
                                    @if (_formModel.OrderType == "Limit")
                                    {
                                        <label class="form-label">Price (@_formModel.QuoteAsset.ToUpperInvariant())</label>
                                        <InputNumber class="form-control" @bind-Value="_formModel.Price" />
                                        <small class="text-muted">Price per @_formModel.BaseAsset.ToUpperInvariant()</small>
                                    }
                                </div>
                            </div>

                            @if (_formModel.OrderType == "Limit" && _formModel.Quantity > 0 && _formModel.Price > 0)
                            {
                                <div class="alert alert-secondary mb-3">
                                    <strong>Total:</strong> 
                                    @FormatPrice(_formModel.Quantity * _formModel.Price) @_formModel.QuoteAsset.ToUpperInvariant()
                                </div>
                            }

                            @if (_error != null)
                            {
                                <div class="alert alert-danger">
                                    <span class="bi bi-exclamation-triangle me-2"></span>@_error
                                </div>
                            }

                            <div class="d-flex justify-content-end gap-2">
                                <a href="/trading/orders" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn @(_formModel.Side == "Buy" ? "btn-success" : "btn-danger")" 
                                        disabled="@_isSubmitting">
                                    @if (_isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    @_formModel.Side @_formModel.BaseAsset.ToUpperInvariant()
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><span class="bi bi-info-circle me-2"></span>Order Info</h5>
                    </div>
                    <div class="card-body">
                        <h6>Order Types</h6>
                        <dl>
                            <dt>Limit Order</dt>
                            <dd class="text-muted small">
                                Execute at specified price or better. May not fill immediately.
                            </dd>
                            <dt>Market Order</dt>
                            <dd class="text-muted small">
                                Execute immediately at current market price.
                            </dd>
                        </dl>

                        <hr />

                        <h6 class="text-warning">
                            <span class="bi bi-exclamation-triangle me-1"></span>Risk Warning
                        </h6>
                        <p class="text-muted small mb-0">
                            Trading cryptocurrencies carries significant risk. Only trade with funds you can afford to lose.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Base { get; set; }

    [SupplyParameterFromQuery]
    public string? Quote { get; set; }

    [SupplyParameterFromQuery]
    public string? Side { get; set; }

    private List<ExchangeAccount> _accounts = [];
    private Price? _currentPrice;
    private bool _isSubmitting;
    private bool _isFetchingPrice;
    private string? _error;
    private OrderFormModel _formModel = new();

    protected override async Task OnInitializedAsync()
    {
        _accounts = (await ExchangeAccountStore.ListAsync(default)).ToList();
        
        // Pre-fill from query parameters
        if (!string.IsNullOrEmpty(Base))
            _formModel.BaseAsset = Base.ToUpperInvariant();
        if (!string.IsNullOrEmpty(Quote))
            _formModel.QuoteAsset = Quote.ToUpperInvariant();
        if (!string.IsNullOrEmpty(Side))
            _formModel.Side = Side.Equals("sell", StringComparison.OrdinalIgnoreCase) ? "Sell" : "Buy";
        
        // Set default account if only one with credentials exists
        var accountsWithCredentials = _accounts.Where(a => 
            a.Status == ExchangeAccountStatus.Connected || 
            a.Status == ExchangeAccountStatus.CredentialsPresent).ToList();
        if (accountsWithCredentials.Count == 1)
            _formModel.AccountId = accountsWithCredentials[0].Id.ToString();
    }

    private async Task FetchCurrentPriceAsync()
    {
        if (string.IsNullOrEmpty(_formModel.BaseAsset) || string.IsNullOrEmpty(_formModel.QuoteAsset))
        {
            _error = "Please enter both base and quote assets";
            return;
        }

        try
        {
            _isFetchingPrice = true;
            _error = null;
            _currentPrice = await ExchangeService.FetchPriceAsync(
                _formModel.BaseAsset.ToUpperInvariant(), 
                _formModel.QuoteAsset.ToUpperInvariant());
            
            // Auto-fill price for limit orders
            if (_formModel.OrderType == "Limit" && _formModel.Price == 0)
            {
                _formModel.Price = _currentPrice.Value;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to fetch price");
            _error = ex.Message;
        }
        finally
        {
            _isFetchingPrice = false;
        }
    }

    private async Task SubmitOrderAsync()
    {
        try
        {
            _isSubmitting = true;
            _error = null;

            if (string.IsNullOrEmpty(_formModel.AccountId))
            {
                _error = "Please select an exchange account";
                return;
            }

            if (_formModel.Quantity <= 0)
            {
                _error = "Quantity must be greater than zero";
                return;
            }

            var accountId = Guid.Parse(_formModel.AccountId);
            var account = _accounts.FirstOrDefault(a => a.Id == accountId);
            if (account == null)
            {
                _error = "Selected account not found";
                return;
            }

            var baseAsset = _formModel.BaseAsset.ToUpperInvariant();
            var quoteAsset = _formModel.QuoteAsset.ToUpperInvariant();
            var side = _formModel.Side == "Buy" ? OrderSide.Buy : OrderSide.Sell;

            Order order;
            if (_formModel.OrderType == "Market")
            {
                order = Order.CreateMarketOrder(accountId, baseAsset, quoteAsset, side, _formModel.Quantity);
            }
            else
            {
                if (_formModel.Price <= 0)
                {
                    _error = "Price must be greater than zero for limit orders";
                    return;
                }
                order = Order.CreateLimitOrder(accountId, baseAsset, quoteAsset, side, _formModel.Quantity, _formModel.Price);
            }

            // Get exchange and place order
            var exchange = ExchangeRegistry.GetByCode(account.ExchangeCode);
            if (exchange == null)
            {
                _error = $"Exchange '{account.ExchangeCode}' not available";
                return;
            }

            if (account.Credentials == null)
            {
                _error = "Account has no API credentials configured";
                return;
            }

            var placedOrder = await exchange.PlaceOrderAsync(account.Credentials, order);
            
            // Save to local store
            await OrderStore.SaveAsync(placedOrder);

            Logger.LogInformation("Order placed successfully: {OrderId}", placedOrder.Id);
            NavigationManager.NavigateTo("/trading/orders");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to place order");
            _error = ex.Message;
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private static string FormatPrice(decimal price) => price switch
    {
        >= 1000 => price.ToString("N2"),
        >= 1 => price.ToString("N4"),
        >= 0.01m => price.ToString("N6"),
        _ => price.ToString("N8")
    };

    private class OrderFormModel
    {
        public string AccountId { get; set; } = "";
        public string BaseAsset { get; set; } = "BTC";
        public string QuoteAsset { get; set; } = "USDT";
        public string Side { get; set; } = "Buy";
        public string OrderType { get; set; } = "Limit";
        public decimal Quantity { get; set; }
        public decimal Price { get; set; }
    }
}
