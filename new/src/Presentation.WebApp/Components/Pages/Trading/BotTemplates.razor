@page "/trading/bots/templates"
@using Application.Trading.Bots.Abstractions
@using Domain.Trading.Bots.Enums
@using Domain.Trading.Bots.Models
@using Domain.Trading.Bots.ValueObjects
@using Microsoft.AspNetCore.Authorization
@inject IBotTemplateStore BotTemplateStore
@inject IStrategyRegistry StrategyRegistry
@inject ILogger<BotTemplates> Logger
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Bot Templates</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <span class="bi bi-robot me-2"></span>Bot Templates
            </h1>
            <p class="text-muted">Create and manage trading bot templates</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowCreateModal">
                <span class="bi bi-plus-lg me-2"></span>Create Template
            </button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_templates.Count == 0)
    {
        <div class="alert alert-info">
            <span class="bi bi-info-circle me-2"></span>
            No bot templates found. Create your first template to get started.
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var template in _templates)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">@template.Name</h5>
                            <span class="badge bg-@GetBotTypeBadgeColor(template.BotType)">@template.BotType</span>
                        </div>
                        <div class="card-body">
                            @if (!string.IsNullOrEmpty(template.Description))
                            {
                                <p class="card-text text-muted">@template.Description</p>
                            }
                            <dl class="row mb-0">
                                <dt class="col-sm-5">Strategy</dt>
                                <dd class="col-sm-7">@GetStrategyName(template.StrategyId)</dd>
                                <dt class="col-sm-5">Base Currency</dt>
                                <dd class="col-sm-7">@template.MeshConfig.BaseCurrency</dd>
                                <dt class="col-sm-5">Max Position</dt>
                                <dd class="col-sm-7">@template.RiskSettings.MaxPositionSizePercent%</dd>
                            </dl>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100">
                                <a class="btn btn-outline-primary" href="/trading/bots/templates/@template.Id/instances">
                                    <span class="bi bi-play-fill me-1"></span>Instances
                                </a>
                                <button class="btn btn-outline-secondary" @onclick="() => EditTemplate(template)">
                                    <span class="bi bi-pencil me-1"></span>Edit
                                </button>
                                <button class="btn btn-outline-danger" @onclick="() => DeleteTemplate(template.Id)">
                                    <span class="bi bi-trash me-1"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* Create/Edit Modal *@
@if (_showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(_editingTemplate is null ? "Create Bot Template" : "Edit Bot Template")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="_formModel" OnValidSubmit="SaveTemplate">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <InputText class="form-control" @bind-Value="_formModel.Name" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" rows="2" @bind-Value="_formModel.Description" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Bot Type</label>
                                <InputSelect class="form-select" @bind-Value="_formModel.BotType">
                                    @foreach (var botType in Enum.GetValues<BotType>())
                                    {
                                        <option value="@botType">@botType</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Strategy</label>
                                <InputSelect class="form-select" @bind-Value="_formModel.StrategyId">
                                    @foreach (var strategy in _availableStrategies)
                                    {
                                        <option value="@strategy.StrategyId">@strategy.Name</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Base Currency</label>
                                <InputText class="form-control" @bind-Value="_formModel.BaseCurrency" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Allowed Assets (comma-separated)</label>
                                <InputText class="form-control" @bind-Value="_formModel.AllowedAssets" placeholder="BTC,ETH,SOL" />
                            </div>
                        </div>

                        <h6 class="mt-4">Risk Settings</h6>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Max Position Size %</label>
                                <InputNumber class="form-control" @bind-Value="_formModel.MaxPositionSizePercent" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Stop Loss %</label>
                                <InputNumber class="form-control" @bind-Value="_formModel.StopLossPercent" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Take Profit %</label>
                                <InputNumber class="form-control" @bind-Value="_formModel.TakeProfitPercent" />
                            </div>
                        </div>

                        <div class="modal-footer px-0 pb-0">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                @(_editingTemplate is null ? "Create" : "Save Changes")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _isLoading = true;
    private List<BotTemplate> _templates = [];
    private List<ITradingStrategy> _availableStrategies = [];
    private bool _showModal;
    private BotTemplate? _editingTemplate;
    private BotTemplateFormModel _formModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplatesAsync();
        _availableStrategies = StrategyRegistry.GetAllStrategies().ToList();
    }

    private async Task LoadTemplatesAsync()
    {
        _isLoading = true;
        try
        {
            var templates = await BotTemplateStore.GetAllAsync();
            _templates = templates.ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading bot templates");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowCreateModal()
    {
        _editingTemplate = null;
        _formModel = new BotTemplateFormModel
        {
            BotType = BotType.Trading,
            StrategyId = _availableStrategies.FirstOrDefault()?.StrategyId ?? "",
            BaseCurrency = "USDT",
            MaxPositionSizePercent = 10,
            StopLossPercent = 2
        };
        _showModal = true;
    }

    private void EditTemplate(BotTemplate template)
    {
        _editingTemplate = template;
        _formModel = new BotTemplateFormModel
        {
            Name = template.Name,
            Description = template.Description,
            BotType = template.BotType,
            StrategyId = template.StrategyId,
            BaseCurrency = template.MeshConfig.BaseCurrency,
            AllowedAssets = template.MeshConfig.AllowedAssets is not null 
                ? string.Join(",", template.MeshConfig.AllowedAssets) 
                : "",
            MaxPositionSizePercent = template.RiskSettings.MaxPositionSizePercent,
            StopLossPercent = template.RiskSettings.StopLossPercent,
            TakeProfitPercent = template.RiskSettings.TakeProfitPercent
        };
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
        _editingTemplate = null;
    }

    private async Task SaveTemplate()
    {
        try
        {
            var allowedAssets = string.IsNullOrWhiteSpace(_formModel.AllowedAssets)
                ? null
                : _formModel.AllowedAssets.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();

            var meshConfig = MeshConfig.Create(allowedAssets, _formModel.BaseCurrency ?? "USDT");
            var riskSettings = RiskSettings.Create(
                _formModel.MaxPositionSizePercent,
                _formModel.StopLossPercent,
                _formModel.TakeProfitPercent);

            if (_editingTemplate is not null)
            {
                _editingTemplate.Update(
                    _formModel.Name,
                    _formModel.Description,
                    meshConfig,
                    null,
                    riskSettings);
                await BotTemplateStore.UpdateAsync(_editingTemplate);
            }
            else
            {
                var template = BotTemplate.Create(
                    _formModel.Name ?? "New Template",
                    Guid.Empty, // TODO: Get current user ID
                    _formModel.BotType,
                    _formModel.StrategyId ?? "",
                    meshConfig,
                    null,
                    riskSettings,
                    _formModel.Description);
                await BotTemplateStore.CreateAsync(template);
            }

            CloseModal();
            await LoadTemplatesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving bot template");
        }
    }

    private async Task DeleteTemplate(Guid id)
    {
        try
        {
            await BotTemplateStore.DeleteAsync(id);
            await LoadTemplatesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting bot template");
        }
    }

    private string GetBotTypeBadgeColor(BotType type) => type switch
    {
        BotType.Trading => "primary",
        BotType.Alert => "warning",
        _ => "secondary"
    };

    private string GetStrategyName(string strategyId)
    {
        var strategy = StrategyRegistry.GetStrategy(strategyId);
        return strategy?.Name ?? strategyId;
    }

    private class BotTemplateFormModel
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public BotType BotType { get; set; }
        public string? StrategyId { get; set; }
        public string? BaseCurrency { get; set; }
        public string? AllowedAssets { get; set; }
        public decimal MaxPositionSizePercent { get; set; }
        public decimal StopLossPercent { get; set; }
        public decimal? TakeProfitPercent { get; set; }
    }
}
