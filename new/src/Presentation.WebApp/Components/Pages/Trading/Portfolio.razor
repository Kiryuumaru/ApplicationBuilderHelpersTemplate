@page "/trading/portfolio"
@using Application.Trading.Bots.Abstractions
@using Domain.Trading.Bots.Enums
@using Domain.Trading.Bots.Models
@using Domain.Identity.Models
@using Microsoft.AspNetCore.Identity
@inject IBotInstanceStore BotInstanceStore
@inject IBotTemplateStore BotTemplateStore
@inject IPositionStore PositionStore
@inject IBotSignalStore SignalStore
@inject UserManager<User> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Portfolio> Logger
@rendermode InteractiveServer
@attribute [Authorize]
@implements IDisposable

<PageTitle>Portfolio Analytics</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <span class="bi bi-briefcase me-2"></span>Portfolio Analytics
            </h1>
            <p class="text-muted">Aggregated view across all trading bots</p>
        </div>
        <div class="col-auto">
            <div class="btn-group me-2">
                <button class="btn @(_timeRange == "24h" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetTimeRange("24h")'>24H</button>
                <button class="btn @(_timeRange == "7d" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetTimeRange("7d")'>7D</button>
                <button class="btn @(_timeRange == "30d" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetTimeRange("30d")'>30D</button>
                <button class="btn @(_timeRange == "all" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetTimeRange("all")'>All</button>
            </div>
            <button class="btn btn-outline-secondary" @onclick="RefreshAsync">
                <span class="bi bi-arrow-clockwise me-1"></span>Refresh
            </button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Portfolio Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted mb-1">Total Portfolio Value</h6>
                                <h3 class="mb-0">@_totalValue.ToString("C")</h3>
                            </div>
                            <span class="bi bi-wallet2 fs-1 text-primary opacity-50"></span>
                        </div>
                        <small class="@(_totalPnL >= 0 ? "text-success" : "text-danger")">
                            <span class="bi @(_totalPnL >= 0 ? "bi-arrow-up" : "bi-arrow-down")"></span>
                            @(_totalPnL >= 0 ? "+" : "")@_totalPnL.ToString("C") (@_totalPnLPercent.ToString("F2")%)
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted mb-1">Realized P/L</h6>
                                <h3 class="mb-0 @(_realizedPnL >= 0 ? "text-success" : "text-danger")">
                                    @(_realizedPnL >= 0 ? "+" : "")@_realizedPnL.ToString("C")
                                </h3>
                            </div>
                            <span class="bi bi-cash-coin fs-1 text-success opacity-50"></span>
                        </div>
                        <small class="text-muted">From closed positions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted mb-1">Unrealized P/L</h6>
                                <h3 class="mb-0 @(_unrealizedPnL >= 0 ? "text-success" : "text-danger")">
                                    @(_unrealizedPnL >= 0 ? "+" : "")@_unrealizedPnL.ToString("C")
                                </h3>
                            </div>
                            <span class="bi bi-graph-up-arrow fs-1 text-warning opacity-50"></span>
                        </div>
                        <small class="text-muted">From @_openPositions.Count open positions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted mb-1">Win Rate</h6>
                                <h3 class="mb-0">@_winRate.ToString("F1")%</h3>
                            </div>
                            <span class="bi bi-trophy fs-1 text-info opacity-50"></span>
                        </div>
                        <small class="text-muted">
                            @_winningTrades W / @_losingTrades L
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Stats Row -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="text-muted mb-1">Total Trades</h6>
                        <h4 class="mb-0">@_totalTrades</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="text-muted mb-1">Avg. Trade</h6>
                        <h4 class="mb-0 @(_avgTradePnL >= 0 ? "text-success" : "text-danger")">
                            @_avgTradePnL.ToString("C")
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="text-muted mb-1">Best Trade</h6>
                        <h4 class="mb-0 text-success">@_bestTrade.ToString("C")</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="text-muted mb-1">Worst Trade</h6>
                        <h4 class="mb-0 text-danger">@_worstTrade.ToString("C")</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="text-muted mb-1">Max Drawdown</h6>
                        <h4 class="mb-0 text-danger">@_maxDrawdown.ToString("F2")%</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body py-3">
                        <h6 class="text-muted mb-1">Profit Factor</h6>
                        <h4 class="mb-0">@_profitFactor.ToString("F2")</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- P/L by Bot -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="bi bi-robot me-2"></span>P/L by Bot
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (_botPnL.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Bot</th>
                                            <th>Status</th>
                                            <th class="text-end">P/L</th>
                                            <th class="text-end">%</th>
                                            <th class="text-end">Trades</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var bot in _botPnL.OrderByDescending(b => b.PnL))
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@bot.Name</strong>
                                                    <br /><small class="text-muted">@bot.Strategy</small>
                                                </td>
                                                <td>
                                                    <span class="badge @GetStatusBadgeClass(bot.Status)">@bot.Status</span>
                                                </td>
                                                <td class="text-end @(bot.PnL >= 0 ? "text-success" : "text-danger")">
                                                    @(bot.PnL >= 0 ? "+" : "")@bot.PnL.ToString("C")
                                                </td>
                                                <td class="text-end @(bot.PnLPercent >= 0 ? "text-success" : "text-danger")">
                                                    @(bot.PnLPercent >= 0 ? "+" : "")@bot.PnLPercent.ToString("F2")%
                                                </td>
                                                <td class="text-end">@bot.TradeCount</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <span class="bi bi-inbox fs-1"></span>
                                <p class="mt-2">No bot data available</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- P/L by Asset -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="bi bi-currency-bitcoin me-2"></span>P/L by Asset
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (_assetPnL.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Asset</th>
                                            <th class="text-end">P/L</th>
                                            <th class="text-end">Trades</th>
                                            <th class="text-end">Win Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var asset in _assetPnL.OrderByDescending(a => a.PnL))
                                        {
                                            <tr>
                                                <td><strong>@asset.Asset</strong></td>
                                                <td class="text-end @(asset.PnL >= 0 ? "text-success" : "text-danger")">
                                                    @(asset.PnL >= 0 ? "+" : "")@asset.PnL.ToString("C")
                                                </td>
                                                <td class="text-end">@asset.TradeCount</td>
                                                <td class="text-end">@asset.WinRate.ToString("F1")%</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <span class="bi bi-inbox fs-1"></span>
                                <p class="mt-2">No asset data available</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Positions -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span class="bi bi-collection me-2"></span>Open Positions (@_openPositions.Count)
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (_openPositions.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Bot</th>
                                            <th>Pair</th>
                                            <th>Side</th>
                                            <th class="text-end">Entry</th>
                                            <th class="text-end">Current</th>
                                            <th class="text-end">Qty</th>
                                            <th class="text-end">Unrealized P/L</th>
                                            <th>Opened</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var position in _openPositions.OrderByDescending(p => Math.Abs(p.UnrealizedPnL)))
                                        {
                                            var botName = _botNames.GetValueOrDefault(position.BotInstanceId, "Unknown");
                                            <tr>
                                                <td>@botName</td>
                                                <td>
                                                    <strong>@position.TradingPair.BaseAsset</strong>/@position.TradingPair.QuoteAsset
                                                </td>
                                                <td>
                                                    <span class="badge @(position.Side == PositionSide.Long ? "bg-success" : "bg-danger")">
                                                        @position.Side
                                                    </span>
                                                </td>
                                                <td class="text-end">@position.EntryPrice.ToString("F8")</td>
                                                <td class="text-end">@position.CurrentPrice.ToString("F8")</td>
                                                <td class="text-end">@position.Quantity.ToString("F4")</td>
                                                <td class="text-end @(position.UnrealizedPnL >= 0 ? "text-success" : "text-danger")">
                                                    @(position.UnrealizedPnL >= 0 ? "+" : "")@position.UnrealizedPnL.ToString("C")
                                                </td>
                                                <td>
                                                    <small class="text-muted">@position.OpenedAt.LocalDateTime.ToString("g")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <span class="bi bi-inbox fs-1"></span>
                                <p class="mt-2">No open positions</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Closed Positions -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="bi bi-clock-history me-2"></span>Recent Closed Positions
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (_closedPositions.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Bot</th>
                                            <th>Pair</th>
                                            <th>Side</th>
                                            <th class="text-end">Entry</th>
                                            <th class="text-end">Exit</th>
                                            <th class="text-end">Qty</th>
                                            <th class="text-end">Realized P/L</th>
                                            <th>Duration</th>
                                            <th>Closed</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var position in _closedPositions.Take(20))
                                        {
                                            var botName = _botNames.GetValueOrDefault(position.BotInstanceId, "Unknown");
                                            var duration = position.ClosedAt.HasValue
                                                ? position.ClosedAt.Value - position.OpenedAt
                                                : TimeSpan.Zero;
                                            <tr>
                                                <td>@botName</td>
                                                <td>
                                                    <strong>@position.TradingPair.BaseAsset</strong>/@position.TradingPair.QuoteAsset
                                                </td>
                                                <td>
                                                    <span class="badge @(position.Side == PositionSide.Long ? "bg-success" : "bg-danger")">
                                                        @position.Side
                                                    </span>
                                                </td>
                                                <td class="text-end">@position.EntryPrice.ToString("F8")</td>
                                                <td class="text-end">@position.CurrentPrice.ToString("F8")</td>
                                                <td class="text-end">@position.Quantity.ToString("F4")</td>
                                                <td class="text-end @((position.RealizedPnL ?? 0) >= 0 ? "text-success" : "text-danger")">
                                                    @((position.RealizedPnL ?? 0) >= 0 ? "+" : "")@(position.RealizedPnL ?? 0).ToString("C")
                                                </td>
                                                <td>
                                                    <small>@FormatDuration(duration)</small>
                                                </td>
                                                <td>
                                                    <small class="text-muted">@position.ClosedAt?.LocalDateTime.ToString("g")</small>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <span class="bi bi-inbox fs-1"></span>
                                <p class="mt-2">No closed positions in selected time range</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private string _timeRange = "7d";
    private Guid? _userId;
    private System.Threading.Timer? _refreshTimer;

    // Summary stats
    private decimal _totalValue;
    private decimal _totalPnL;
    private decimal _totalPnLPercent;
    private decimal _realizedPnL;
    private decimal _unrealizedPnL;
    private decimal _winRate;
    private int _winningTrades;
    private int _losingTrades;
    private int _totalTrades;
    private decimal _avgTradePnL;
    private decimal _bestTrade;
    private decimal _worstTrade;
    private decimal _maxDrawdown;
    private decimal _profitFactor;

    // Data
    private List<BotInstance> _instances = [];
    private List<BotTemplate> _templates = [];
    private List<Position> _openPositions = [];
    private List<Position> _closedPositions = [];
    private List<BotPnLSummary> _botPnL = [];
    private List<AssetPnLSummary> _assetPnL = [];
    private Dictionary<Guid, string> _botNames = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAsync();
        await LoadDataAsync();
        
        // Refresh every 30 seconds
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadDataAsync();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task LoadUserAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        _userId = user?.Id;
    }

    private async Task LoadDataAsync()
    {
        if (!_userId.HasValue)
        {
            _isLoading = false;
            return;
        }

        try
        {
            // Load instances and templates
            _instances = (await BotInstanceStore.GetByUserIdAsync(_userId.Value)).ToList();
            _templates = (await BotTemplateStore.GetByUserIdAsync(_userId.Value)).ToList();

            // Build bot name lookup
            _botNames = _instances.ToDictionary(
                i => i.Id,
                i => _templates.FirstOrDefault(t => t.Id == i.BotTemplateId)?.Name ?? "Unknown");

            // Load all positions
            var allPositions = new List<Position>();
            foreach (var instance in _instances)
            {
                var positions = await PositionStore.GetByInstanceIdAsync(instance.Id);
                allPositions.AddRange(positions);
            }

            // Filter by time range
            var cutoff = GetTimeRangeCutoff();
            _openPositions = allPositions.Where(p => p.IsOpen).ToList();
            _closedPositions = allPositions
                .Where(p => !p.IsOpen && p.ClosedAt >= cutoff)
                .OrderByDescending(p => p.ClosedAt)
                .ToList();

            // Calculate stats
            CalculateStats();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load portfolio data");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void CalculateStats()
    {
        // Total value = sum of initial balances + unrealized P/L
        _totalValue = _instances.Sum(i => i.CurrentBalance);
        var initialValue = _instances.Sum(i => i.InitialBalance);
        _totalPnL = _totalValue - initialValue;
        _totalPnLPercent = initialValue > 0 ? (_totalPnL / initialValue) * 100 : 0;

        // Realized and unrealized
        _realizedPnL = _closedPositions.Sum(p => p.RealizedPnL ?? 0);
        _unrealizedPnL = _openPositions.Sum(p => p.UnrealizedPnL);

        // Trade stats
        _winningTrades = _closedPositions.Count(p => (p.RealizedPnL ?? 0) > 0);
        _losingTrades = _closedPositions.Count(p => (p.RealizedPnL ?? 0) < 0);
        _totalTrades = _closedPositions.Count;
        _winRate = _totalTrades > 0 ? (_winningTrades / (decimal)_totalTrades) * 100 : 0;

        _avgTradePnL = _totalTrades > 0 ? _realizedPnL / _totalTrades : 0;
        _bestTrade = _closedPositions.Any() ? _closedPositions.Max(p => p.RealizedPnL ?? 0) : 0;
        _worstTrade = _closedPositions.Any() ? _closedPositions.Min(p => p.RealizedPnL ?? 0) : 0;

        // Profit factor
        var grossProfit = _closedPositions.Where(p => (p.RealizedPnL ?? 0) > 0).Sum(p => p.RealizedPnL ?? 0);
        var grossLoss = Math.Abs(_closedPositions.Where(p => (p.RealizedPnL ?? 0) < 0).Sum(p => p.RealizedPnL ?? 0));
        _profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 999.99m : 0;

        // Max drawdown (simplified - would need equity curve for accurate calculation)
        _maxDrawdown = initialValue > 0 ? Math.Max(0, (initialValue - _totalValue) / initialValue * 100) : 0;

        // P/L by bot
        _botPnL = _instances
            .Select(i => new BotPnLSummary
            {
                InstanceId = i.Id,
                Name = _botNames.GetValueOrDefault(i.Id, "Unknown"),
                Strategy = _templates.FirstOrDefault(t => t.Id == i.BotTemplateId)?.StrategyId ?? "Unknown",
                Status = i.Status,
                PnL = i.CurrentBalance - i.InitialBalance,
                PnLPercent = i.InitialBalance > 0 ? ((i.CurrentBalance - i.InitialBalance) / i.InitialBalance) * 100 : 0,
                TradeCount = _closedPositions.Count(p => p.BotInstanceId == i.Id)
            })
            .ToList();

        // P/L by asset
        var assetGroups = _closedPositions
            .GroupBy(p => p.TradingPair.BaseAsset.Symbol)
            .Select(g => new AssetPnLSummary
            {
                Asset = g.Key,
                PnL = g.Sum(p => p.RealizedPnL ?? 0),
                TradeCount = g.Count(),
                WinRate = g.Count() > 0 ? g.Count(p => (p.RealizedPnL ?? 0) > 0) / (decimal)g.Count() * 100 : 0
            })
            .ToList();

        _assetPnL = assetGroups;
    }

    private DateTimeOffset GetTimeRangeCutoff()
    {
        return _timeRange switch
        {
            "24h" => DateTimeOffset.UtcNow.AddDays(-1),
            "7d" => DateTimeOffset.UtcNow.AddDays(-7),
            "30d" => DateTimeOffset.UtcNow.AddDays(-30),
            _ => DateTimeOffset.MinValue
        };
    }

    private void SetTimeRange(string range)
    {
        _timeRange = range;
        _ = LoadDataAsync();
    }

    private async Task RefreshAsync()
    {
        _isLoading = true;
        await LoadDataAsync();
    }

    private string GetStatusBadgeClass(BotInstanceStatus status)
    {
        return status switch
        {
            BotInstanceStatus.Running => "bg-success",
            BotInstanceStatus.Paused => "bg-warning text-dark",
            BotInstanceStatus.Stopped => "bg-secondary",
            BotInstanceStatus.Completed => "bg-info",
            BotInstanceStatus.Error => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalDays >= 1)
            return $"{duration.Days}d {duration.Hours}h";
        if (duration.TotalHours >= 1)
            return $"{duration.Hours}h {duration.Minutes}m";
        return $"{duration.Minutes}m";
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private class BotPnLSummary
    {
        public Guid InstanceId { get; set; }
        public string Name { get; set; } = "";
        public string Strategy { get; set; } = "";
        public BotInstanceStatus Status { get; set; }
        public decimal PnL { get; set; }
        public decimal PnLPercent { get; set; }
        public int TradeCount { get; set; }
    }

    private class AssetPnLSummary
    {
        public string Asset { get; set; } = "";
        public decimal PnL { get; set; }
        public int TradeCount { get; set; }
        public decimal WinRate { get; set; }
    }
}
