@page "/trading/backtest"
@using Application.Trading.Bots.Abstractions
@using Domain.Trading.Bots.Enums
@using Domain.Trading.Bots.Models
@using Domain.Trading.Bots.ValueObjects
@using Domain.Identity.Models
@using Microsoft.AspNetCore.Identity
@inject IBotTemplateStore BotTemplateStore
@inject IBotInstanceStore BotInstanceStore
@inject IBacktestingEngine BacktestingEngine
@inject IStrategyRegistry StrategyRegistry
@inject UserManager<User> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Backtest> Logger
@rendermode InteractiveServer
@attribute [Authorize]
@implements IDisposable

<PageTitle>Backtest</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <span class="bi bi-clock-history me-2"></span>Strategy Backtesting
            </h1>
            <p class="text-muted">Test your trading strategies against historical data</p>
        </div>
    </div>

    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="bi bi-gear me-2"></span>Backtest Configuration</h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Bot Instance</label>
                            <select class="form-select" @bind="_selectedInstanceId">
                                <option value="">Select an instance...</option>
                                @foreach (var instance in _instances.Where(i => i.Mode == ExecutionMode.Backtest))
                                {
                                    var template = _templates.FirstOrDefault(t => t.Id == instance.BotTemplateId);
                                    <option value="@instance.Id">@(template?.Name ?? "Unknown") - @instance.ExchangeCode</option>
                                }
                            </select>
                            <small class="text-muted">Only backtest-mode instances are shown</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Trading Pair</label>
                            <input type="text" class="form-control" @bind="_tradingPair" placeholder="e.g., BTCUSDT" />
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" @bind="_startDate" />
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" @bind="_endDate" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Initial Capital</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" @bind="_initialCapital" step="100" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Commission (%)</label>
                            <input type="number" class="form-control" @bind="_commissionPercent" step="0.01" />
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary" @onclick="RunBacktestAsync" disabled="@(_isRunning || string.IsNullOrEmpty(_selectedInstanceId))">
                                @if (_isRunning)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                    <text>Running...</text>
                                }
                                else
                                {
                                    <span class="bi bi-play-fill me-1"></span>
                                    <text>Run Backtest</text>
                                }
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            @if (_isRunning)
            {
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><span class="bi bi-hourglass-split me-2"></span>Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @(_progressPercent)%">
                                @(_progressPercent.ToString("N0"))%
                            </div>
                        </div>
                        <small class="text-muted">@_progressMessage</small>
                    </div>
                </div>
            }
        </div>

        <!-- Results Panel -->
        <div class="col-lg-8">
            @if (_result != null)
            {
                <!-- Performance Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><span class="bi bi-bar-chart me-2"></span>Performance Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center mb-3">
                                <div class="h4 mb-0 @(_result.TotalPnL >= 0 ? "text-success" : "text-danger")">
                                    @(_result.TotalPnL >= 0 ? "+" : "")$@_result.TotalPnL.ToString("N2")
                                </div>
                                <small class="text-muted">Total P/L</small>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="h4 mb-0 @(_result.TotalPnLPercent >= 0 ? "text-success" : "text-danger")">
                                    @(_result.TotalPnLPercent >= 0 ? "+" : "")@_result.TotalPnLPercent.ToString("N2")%
                                </div>
                                <small class="text-muted">Return</small>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="h4 mb-0">@_result.WinRate.ToString("N1")%</div>
                                <small class="text-muted">Win Rate</small>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="h4 mb-0 @(_result.SharpeRatio >= 1 ? "text-success" : _result.SharpeRatio >= 0 ? "text-warning" : "text-danger")">
                                    @_result.SharpeRatio.ToString("N2")
                                </div>
                                <small class="text-muted">Sharpe Ratio</small>
                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-md-4">
                                <dl class="row mb-0 small">
                                    <dt class="col-6">Initial Capital</dt>
                                    <dd class="col-6 text-end">$@_result.InitialBalance.ToString("N2")</dd>
                                    <dt class="col-6">Final Capital</dt>
                                    <dd class="col-6 text-end">$@_result.FinalBalance.ToString("N2")</dd>
                                    <dt class="col-6">Max Drawdown</dt>
                                    <dd class="col-6 text-end text-danger">@_result.MaxDrawdownPercent.ToString("N2")%</dd>
                                </dl>
                            </div>
                            <div class="col-md-4">
                                <dl class="row mb-0 small">
                                    <dt class="col-6">Total Trades</dt>
                                    <dd class="col-6 text-end">@_result.TotalTrades</dd>
                                    <dt class="col-6">Winning Trades</dt>
                                    <dd class="col-6 text-end text-success">@_result.WinningTrades</dd>
                                    <dt class="col-6">Losing Trades</dt>
                                    <dd class="col-6 text-end text-danger">@_result.LosingTrades</dd>
                                </dl>
                            </div>
                            <div class="col-md-4">
                                <dl class="row mb-0 small">
                                    <dt class="col-6">Duration</dt>
                                    <dd class="col-6 text-end">@_result.Duration.TotalDays.ToString("N0") days</dd>
                                    <dt class="col-6">Start</dt>
                                    <dd class="col-6 text-end">@_result.StartTime.ToString("MMM dd")</dd>
                                    <dt class="col-6">End</dt>
                                    <dd class="col-6 text-end">@_result.EndTime.ToString("MMM dd")</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equity Curve -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><span class="bi bi-graph-up me-2"></span>Equity Curve</h5>
                    </div>
                    <div class="card-body">
                        @if (_result.EquityCurve.Count > 0)
                        {
                            <div class="equity-chart" style="height: 250px; position: relative;">
                                <div class="d-flex align-items-end justify-content-between h-100 px-2" style="gap: 2px;">
                                    @{
                                        var maxEquity = _result.EquityCurve.Max(e => e.Balance);
                                        var minEquity = _result.EquityCurve.Min(e => e.Balance);
                                        var range = maxEquity - minEquity;
                                        var sampleSize = Math.Min(100, _result.EquityCurve.Count);
                                        var step = Math.Max(1, _result.EquityCurve.Count / sampleSize);
                                    }
                                    @for (var i = 0; i < _result.EquityCurve.Count; i += step)
                                    {
                                        var point = _result.EquityCurve[i];
                                        var heightPercent = range > 0 ? ((point.Balance - minEquity) / range * 100) : 50;
                                        var color = point.Balance >= _result.InitialBalance ? "#198754" : "#dc3545";
                                        <div style="flex: 1; background-color: @color; height: @(heightPercent)%; min-width: 2px; max-width: 10px;"
                                             title="@point.Timestamp.ToString("yyyy-MM-dd"): $@point.Balance.ToString("N2")"></div>
                                    }
                                </div>
                                <div class="d-flex justify-content-between mt-2 small text-muted">
                                    <span>@_result.EquityCurve.First().Timestamp.ToString("MMM dd")</span>
                                    <span>Min: $@minEquity.ToString("N0") | Max: $@maxEquity.ToString("N0")</span>
                                    <span>@_result.EquityCurve.Last().Timestamp.ToString("MMM dd")</span>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">No equity data available</div>
                        }
                    </div>
                </div>

                <!-- Trade History -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><span class="bi bi-list-check me-2"></span>Trade History</h5>
                        <span class="badge bg-secondary">@_result.Trades.Count trades</span>
                    </div>
                    <div class="card-body p-0">
                        @if (_result.Trades.Count == 0)
                        {
                            <div class="text-center py-4 text-muted">No trades executed</div>
                        }
                        else
                        {
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Time</th>
                                            <th>Type</th>
                                            <th>Symbol</th>
                                            <th>Price</th>
                                            <th>Qty</th>
                                            <th>P/L</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{ var tradeNum = 0; }
                                        @foreach (var trade in _result.Trades.OrderByDescending(t => t.Timestamp))
                                        {
                                            tradeNum++;
                                            <tr class="@(trade.PnL >= 0 ? "" : "table-danger bg-opacity-25")">
                                                <td>@tradeNum</td>
                                                <td><small>@trade.Timestamp.ToString("MM/dd HH:mm")</small></td>
                                                <td>
                                                    <span class="badge @GetSignalBadgeClass(trade.Type)">
                                                        @trade.Type
                                                    </span>
                                                </td>
                                                <td>@trade.Symbol</td>
                                                <td>@trade.Price.ToString("N4")</td>
                                                <td>@trade.Quantity.ToString("N4")</td>
                                                <td class="@(trade.PnL >= 0 ? "text-success" : "text-danger")">
                                                    @(trade.PnL >= 0 ? "+" : "")$@trade.PnL.ToString("N2")
                                                </td>
                                                <td>$@trade.BalanceAfter.ToString("N2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (!_isRunning)
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <span class="bi bi-clock-history text-muted" style="font-size: 4rem;"></span>
                        <h4 class="mt-3">No Backtest Results</h4>
                        <p class="text-muted">Configure your backtest parameters and click "Run Backtest" to see results.</p>
                        <p class="text-muted small">Tip: Create a bot instance with "Backtest" mode first.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private Guid _currentUserId = Guid.Empty;
    private List<BotTemplate> _templates = new();
    private List<BotInstance> _instances = new();
    private string _selectedInstanceId = "";
    private string _tradingPair = "BTCUSDT";
    private DateTime _startDate = DateTime.UtcNow.AddMonths(-3);
    private DateTime _endDate = DateTime.UtcNow;
    private decimal _initialCapital = 10000m;
    private decimal _commissionPercent = 0.1m;
    
    private bool _isRunning;
    private double _progressPercent;
    private string _progressMessage = "";
    private BacktestResult? _result;
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        _currentUserId = user?.Id ?? Guid.Empty;
        
        if (_currentUserId != Guid.Empty)
        {
            _templates = (await BotTemplateStore.GetByUserIdAsync(_currentUserId)).ToList();
            _instances = (await BotInstanceStore.GetByUserIdAsync(_currentUserId)).ToList();
        }
    }

    private async Task RunBacktestAsync()
    {
        if (string.IsNullOrEmpty(_selectedInstanceId)) return;
        if (!Guid.TryParse(_selectedInstanceId, out var instanceId)) return;

        var instance = _instances.FirstOrDefault(i => i.Id == instanceId);
        if (instance == null) return;

        _isRunning = true;
        _result = null;
        _progressPercent = 0;
        _progressMessage = "Initializing...";
        _cts = new CancellationTokenSource();

        try
        {
            var config = BacktestConfig.Create(
                new DateTimeOffset(_startDate, TimeSpan.Zero),
                new DateTimeOffset(_endDate, TimeSpan.Zero));

            var progress = new Progress<BacktestProgress>(p =>
            {
                _progressPercent = p.TotalCandles > 0 
                    ? (double)p.ProcessedCandles / p.TotalCandles * 100 
                    : 0;
                _progressMessage = $"Processing {p.CurrentTimestamp:MMM dd} - Balance: ${p.CurrentBalance:N2}";
                InvokeAsync(StateHasChanged);
            });

            _result = await BacktestingEngine.RunAsync(instanceId, config, progress, _cts.Token);
        }
        catch (OperationCanceledException)
        {
            _progressMessage = "Backtest cancelled";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Backtest failed");
            _progressMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isRunning = false;
            _cts?.Dispose();
            _cts = null;
        }
    }

    private static string GetSignalBadgeClass(SignalType type) => type switch
    {
        SignalType.Buy => "bg-success",
        SignalType.Sell => "bg-danger",
        _ => "bg-secondary"
    };

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
