@page "/trading/orders"
@using Application.Trading.Interfaces
@using Domain.Trading.Enums
@using Domain.Trading.Entities
@inject IOrderStore OrderStore
@inject IExchangeAccountStore ExchangeAccountStore
@inject ILogger<Orders> Logger
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Orders</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>
                <span class="bi bi-list-check me-2"></span>Orders
            </h1>
            <p class="text-muted">View and manage your trading orders</p>
        </div>
        <div class="col-auto">
            <a href="/trading/orders/new" class="btn btn-primary">
                <span class="bi bi-plus-lg me-1"></span>New Order
            </a>
        </div>
    </div>

    @if (!_accounts.Any())
    {
        <div class="alert alert-warning">
            <span class="bi bi-exclamation-triangle me-2"></span>
            You need to <a href="/trading/accounts">add an exchange account</a> before viewing orders.
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-4">
                <label class="form-label">Exchange Account</label>
                <select class="form-select" @onchange="OnAccountChanged">
                    <option value="">All Accounts</option>
                    @foreach (var account in _accounts)
                    {
                        <option value="@account.Id" selected="@(account.Id == _selectedAccountId)">
                            @account.Name (@account.ExchangeCode)
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Status</label>
                <div class="btn-group w-100" role="group">
                    <button class="btn @(_filter == "all" ? "btn-primary" : "btn-outline-primary")"
                            @onclick='() => SetFilter("all")'>All</button>
                    <button class="btn @(_filter == "active" ? "btn-primary" : "btn-outline-primary")"
                            @onclick='() => SetFilter("active")'>Active</button>
                    <button class="btn @(_filter == "filled" ? "btn-primary" : "btn-outline-primary")"
                            @onclick='() => SetFilter("filled")'>Filled</button>
                </div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" @onclick="LoadOrdersAsync">
                    <span class="bi bi-arrow-clockwise me-1"></span>Refresh
                </button>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="d-flex justify-content-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (_error != null)
        {
            <div class="alert alert-danger" role="alert">
                <strong>Error:</strong> @_error
            </div>
        }
        else if (!FilteredOrders.Any())
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <span class="bi bi-inbox display-1 text-muted"></span>
                    <h4 class="mt-3">No Orders</h4>
                    <p class="text-muted">
                        @if (_filter == "all")
                        {
                            <text>You haven't placed any orders yet.</text>
                        }
                        else
                        {
                            <text>No @_filter orders found.</text>
                        }
                    </p>
                    <a href="/trading/orders/new" class="btn btn-primary">
                        <span class="bi bi-plus-lg me-1"></span>Place Your First Order
                    </a>
                </div>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th class="text-end">Quantity</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-end">Filled</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in FilteredOrders.OrderByDescending(o => o.CreatedAt))
                                {
                                    <tr>
                                        <td>
                                            <strong>@order.BaseAsset/@order.QuoteAsset</strong>
                                        </td>
                                        <td>
                                            <span class="badge @(order.Side == OrderSide.Buy ? "bg-success" : "bg-danger")">
                                                @order.Side
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@order.Type</span>
                                        </td>
                                        <td class="text-end">@order.Quantity.ToString("N8")</td>
                                        <td class="text-end">
                                            @if (order.Price.HasValue)
                                            {
                                                @order.Price.Value.ToString("N8")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Market</span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            @order.FilledQuantity.ToString("N8")
                                            <small class="text-muted">
                                                (@((order.Quantity > 0 ? order.FilledQuantity / order.Quantity * 100 : 0).ToString("N1"))%)
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(order.Status)">
                                                @order.Status
                                            </span>
                                        </td>
                                        <td>
                                            <span title="@order.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")">
                                                @order.CreatedAt.ToString("MM-dd HH:mm")
                                            </span>
                                        </td>
                                        <td>
                                            @if (order.IsActive)
                                            {
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelOrderAsync(order)">
                                                    <span class="bi bi-x-lg"></span> Cancel
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col">
                    <p class="text-muted">
                        Showing @FilteredOrders.Count() of @_orders.Count orders
                    </p>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Order> _orders = [];
    private List<ExchangeAccount> _accounts = [];
    private Guid? _selectedAccountId;
    private bool _isLoading = true;
    private string? _error;
    private string _filter = "all";

    private IEnumerable<Order> FilteredOrders
    {
        get
        {
            var filtered = _orders.AsEnumerable();
            
            if (_selectedAccountId.HasValue)
            {
                filtered = filtered.Where(o => o.ExchangeAccountId == _selectedAccountId.Value);
            }

            return _filter switch
            {
                "active" => filtered.Where(o => o.IsActive),
                "filled" => filtered.Where(o => o.Status == OrderStatus.Filled),
                _ => filtered
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _accounts = (await ExchangeAccountStore.ListAsync(default)).ToList();
        if (_accounts.Any())
        {
            await LoadOrdersAsync();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task LoadOrdersAsync()
    {
        try
        {
            _isLoading = true;
            _error = null;
            _orders = [];

            foreach (var account in _accounts)
            {
                var accountOrders = await OrderStore.FindByExchangeAccountIdAsync(account.Id);
                _orders.AddRange(accountOrders);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load orders");
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnAccountChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var id))
        {
            _selectedAccountId = id;
        }
        else
        {
            _selectedAccountId = null;
        }
        await LoadOrdersAsync();
    }

    private void SetFilter(string filter)
    {
        _filter = filter;
    }

    private async Task CancelOrderAsync(Order order)
    {
        try
        {
            order.Cancel();
            await OrderStore.SaveAsync(order);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to cancel order {OrderId}", order.Id);
            _error = ex.Message;
        }
    }

    private static string GetStatusBadgeClass(OrderStatus status) => status switch
    {
        OrderStatus.Pending => "bg-secondary",
        OrderStatus.Open => "bg-primary",
        OrderStatus.PartiallyFilled => "bg-info",
        OrderStatus.Filled => "bg-success",
        OrderStatus.Cancelled => "bg-secondary",
        OrderStatus.Rejected => "bg-danger",
        OrderStatus.Expired => "bg-warning text-dark",
        _ => "bg-secondary"
    };
}
