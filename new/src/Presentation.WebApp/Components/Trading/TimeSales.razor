<div class="time-sales-container" style="height: @(Height)px;">
    <div class="time-sales-header">
        <span class="col-time">Time</span>
        <span class="col-price">Price</span>
        <span class="col-qty">Quantity</span>
    </div>
    <div class="time-sales-body" @ref="_scrollContainer">
        @foreach (var trade in _trades.Take(MaxTrades))
        {
            <div class="time-sales-row @(trade.IsBuyerMaker ? "sell" : "buy")">
                <span class="col-time">@trade.Time.ToString("HH:mm:ss")</span>
                <span class="col-price">@trade.Price.ToString("N2")</span>
                <span class="col-qty">@trade.Quantity.ToString("N4")</span>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int Height { get; set; } = 300;

    [Parameter]
    public int MaxTrades { get; set; } = 100;

    private ElementReference _scrollContainer;
    private readonly LinkedList<TradeEntry> _trades = new();

    public void AddTrade(DateTime time, decimal price, decimal quantity, bool isBuyerMaker)
    {
        var entry = new TradeEntry(time, price, quantity, isBuyerMaker);
        _trades.AddFirst(entry);

        // Keep only MaxTrades entries
        while (_trades.Count > MaxTrades)
        {
            _trades.RemoveLast();
        }

        StateHasChanged();
    }

    public void AddTrades(IEnumerable<(DateTime Time, decimal Price, decimal Quantity, bool IsBuyerMaker)> trades)
    {
        foreach (var trade in trades.OrderByDescending(t => t.Time))
        {
            var entry = new TradeEntry(trade.Time, trade.Price, trade.Quantity, trade.IsBuyerMaker);
            _trades.AddFirst(entry);
        }

        // Keep only MaxTrades entries
        while (_trades.Count > MaxTrades)
        {
            _trades.RemoveLast();
        }

        StateHasChanged();
    }

    public void Clear()
    {
        _trades.Clear();
        StateHasChanged();
    }

    private record TradeEntry(DateTime Time, decimal Price, decimal Quantity, bool IsBuyerMaker);
}
