@using Microsoft.JSInterop
@implements IAsyncDisposable

<div id="@_elementId" class="order-book-container" style="height: @(Height)px; width: 100%;"></div>

@code {
    [Parameter]
    public int Height { get; set; } = 300;

    [Parameter]
    public string BackgroundColor { get; set; } = "#1e222d";

    [Parameter]
    public string BidColor { get; set; } = "rgba(38, 166, 154, 0.4)";

    [Parameter]
    public string AskColor { get; set; } = "rgba(239, 83, 80, 0.4)";

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    private readonly string _elementId = $"orderbook-{Guid.NewGuid():N}";
    private IJSObjectReference? _chartModule;
    private bool _isInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _chartModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "/js/trading-charts.js");

            await _chartModule.InvokeVoidAsync("initializeOrderBook", _elementId, new
            {
                height = Height,
                backgroundColor = BackgroundColor,
                bidColor = BidColor,
                askColor = AskColor,
            });

            _isInitialized = true;
        }
    }

    public async Task UpdateAsync(IEnumerable<OrderBookLevel> bids, IEnumerable<OrderBookLevel> asks)
    {
        if (!_isInitialized || _chartModule == null) return;

        var bidData = bids.Select(b => new { price = (double)b.Price, quantity = (double)b.Quantity }).ToArray();
        var askData = asks.Select(a => new { price = (double)a.Price, quantity = (double)a.Quantity }).ToArray();

        await _chartModule.InvokeVoidAsync("updateOrderBook", _elementId, bidData, askData);
    }

    public async ValueTask DisposeAsync()
    {
        if (_chartModule != null)
        {
            try
            {
                await _chartModule.InvokeVoidAsync("disposeOrderBook", _elementId);
                await _chartModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, ignore
            }
        }
    }

    public record OrderBookLevel(decimal Price, decimal Quantity);
}
