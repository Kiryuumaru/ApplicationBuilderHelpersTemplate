@using Microsoft.JSInterop
@implements IAsyncDisposable

<div id="@_elementId" class="trading-chart-container" style="height: @(Height)px; width: 100%;"></div>

@code {
    /// <summary>
    /// Represents OHLCV candle data for the chart.
    /// </summary>
    public record CandleData(
        DateTime OpenTime,
        decimal Open,
        decimal High,
        decimal Low,
        decimal Close,
        decimal Volume,
        DateTime CloseTime,
        int NumberOfTrades);

    [Parameter]
    public int Height { get; set; } = 400;

    [Parameter]
    public string BackgroundColor { get; set; } = "#1e222d";

    [Parameter]
    public string TextColor { get; set; } = "#d1d4dc";

    [Parameter]
    public string GridColor { get; set; } = "#2B2B43";

    [Parameter]
    public string UpColor { get; set; } = "#26a69a";

    [Parameter]
    public string DownColor { get; set; } = "#ef5350";

    [Parameter]
    public IEnumerable<CandleData>? InitialData { get; set; }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    private readonly string _elementId = $"chart-{Guid.NewGuid():N}";
    private IJSObjectReference? _chartModule;
    private bool _isInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _chartModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "/js/trading-charts.js");

            await _chartModule.InvokeVoidAsync("initializeChart", _elementId, new
            {
                height = Height,
                backgroundColor = BackgroundColor,
                textColor = TextColor,
                gridColor = GridColor,
                upColor = UpColor,
                downColor = DownColor,
            });

            _isInitialized = true;

            if (InitialData != null && InitialData.Any())
            {
                await SetDataAsync(InitialData);
            }
        }
    }

    public async Task SetDataAsync(IEnumerable<CandleData> candles)
    {
        if (!_isInitialized || _chartModule == null) return;

        var candleList = candles.ToList();
        var jsData = candleList.Select(c => new
        {
            time = new DateTimeOffset(c.OpenTime).ToUnixTimeSeconds(),
            open = (double)c.Open,
            high = (double)c.High,
            low = (double)c.Low,
            close = (double)c.Close,
            volume = (double)c.Volume,
        }).ToArray();

        await _chartModule.InvokeVoidAsync("updateCandlestickData", _elementId, jsData);
        await _chartModule.InvokeVoidAsync("updateVolumeData", _elementId, jsData);
        await _chartModule.InvokeVoidAsync("fitContent", _elementId);
    }

    public async Task AddCandleAsync(CandleData candle)
    {
        if (!_isInitialized || _chartModule == null) return;

        await _chartModule.InvokeVoidAsync("addCandlestick", _elementId, new
        {
            time = new DateTimeOffset(candle.OpenTime).ToUnixTimeSeconds(),
            open = (double)candle.Open,
            high = (double)candle.High,
            low = (double)candle.Low,
            close = (double)candle.Close,
            volume = (double)candle.Volume,
        });
    }

    public async Task AddTradeMarkerAsync(DateTime time, bool isBuy, string? text = null)
    {
        if (!_isInitialized || _chartModule == null) return;

        await _chartModule.InvokeVoidAsync("addMarker", _elementId, new
        {
            time = new DateTimeOffset(time).ToUnixTimeSeconds(),
            position = isBuy ? "belowBar" : "aboveBar",
            color = isBuy ? UpColor : DownColor,
            shape = isBuy ? "arrowUp" : "arrowDown",
            text = text ?? (isBuy ? "BUY" : "SELL"),
        });
    }

    public async Task AddPriceLineAsync(decimal price, string color, string? title = null)
    {
        if (!_isInitialized || _chartModule == null) return;

        await _chartModule.InvokeVoidAsync("addPriceLine", _elementId, (double)price, new
        {
            color,
            title = title ?? "",
        });
    }

    public async Task ClearMarkersAsync()
    {
        if (!_isInitialized || _chartModule == null) return;

        await _chartModule.InvokeVoidAsync("clearMarkers", _elementId);
    }

    public async Task ScrollToRealTimeAsync()
    {
        if (!_isInitialized || _chartModule == null) return;

        await _chartModule.InvokeVoidAsync("scrollToRealTime", _elementId);
    }

    public async ValueTask DisposeAsync()
    {
        if (_chartModule != null)
        {
            try
            {
                await _chartModule.InvokeVoidAsync("disposeChart", _elementId);
                await _chartModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, ignore
            }
        }
    }
}
